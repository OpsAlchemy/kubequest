<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="Vikash Kumar">
    <link rel="canonical" href="https://opsalchemy.github.io/kubequest/compose/10-scheduling/podAffinity-nodeAffinity-deployments/notes/">
    <link rel="shortcut icon" href="../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Kubernetes Scheduling: Pod &amp; Node Affinity - Theory &amp; Practice - CKA Exam Mastery</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <link href="../../../stylesheets/extra.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Kubernetes Scheduling: Pod \u0026amp; Node Affinity - Theory \u0026amp; Practice", url: "#_top", children: [
              {title: "1. Theoretical Foundation: How Affinity Works", url: "#1-theoretical-foundation-how-affinity-works" },
              {title: "2. Pod Affinity Theory: Relationships Between Pods", url: "#2-pod-affinity-theory-relationships-between-pods" },
              {title: "3. Complete Practical Example with Theory Applied", url: "#3-complete-practical-example-with-theory-applied" },
              {title: "4. When to Use Each Feature - Decision Guide", url: "#4-when-to-use-each-feature-decision-guide" },
              {title: "5. Practice Questions", url: "#5-practice-questions" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../javascripts/extra.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../../11-coredns/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../../11-coredns/" class="btn btn-xs btn-link">
        Index
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../nodeselector/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../nodeselector/" class="btn btn-xs btn-link">
        NodeSelector
      </a>
    </div>
    
  </div>

    

    <h1 id="kubernetes-scheduling-pod-node-affinity-theory-practice"><strong>Kubernetes Scheduling: Pod &amp; Node Affinity - Theory &amp; Practice</strong></h1>
<hr />
<h2 id="1-theoretical-foundation-how-affinity-works"><strong>1. Theoretical Foundation: How Affinity Works</strong></h2>
<h3 id="key-concepts"><strong>Key Concepts:</strong></h3>
<ul>
<li><strong>Labels</strong>: Key-value pairs attached to Kubernetes objects (nodes, pods)</li>
<li><strong>Node Affinity</strong>: Rules based on <strong>NODE LABELS</strong></li>
<li><strong>Pod Affinity</strong>: Rules based on <strong>EXISTING POD LABELS</strong></li>
</ul>
<h3 id="node-affinity-operators-explained"><strong>Node Affinity Operators Explained:</strong></h3>
<table>
<thead>
<tr>
<th>Operator</th>
<th>What It Does</th>
<th>Example</th>
<th>When to Use</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>In</code></td>
<td>Value must be in list</td>
<td><code>zone</code> in ["us-east-1a", "us-east-1b"]</td>
<td>Specific values allowed</td>
</tr>
<tr>
<td><code>NotIn</code></td>
<td>Value must NOT be in list</td>
<td><code>node-type</code> not in ["spot", "preemptible"]</td>
<td>Exclude certain node types</td>
</tr>
<tr>
<td><code>Exists</code></td>
<td>Label key must exist</td>
<td><code>gpu</code> exists</td>
<td>Check for feature presence</td>
</tr>
<tr>
<td><code>DoesNotExist</code></td>
<td>Label key must NOT exist</td>
<td><code>maintenance</code> does not exist</td>
<td>Avoid problematic nodes</td>
</tr>
<tr>
<td><code>Gt</code>, <code>Lt</code></td>
<td>Numeric comparison</td>
<td><code>memory-gb</code> &gt; 16</td>
<td>Resource-based selection</td>
</tr>
</tbody>
</table>
<h3 id="important-theory-points"><strong>Important Theory Points:</strong></h3>
<ol>
<li><strong>NodeSelectorTerms Logic</strong>:</li>
<li><strong>Within a term</strong>: All conditions must be true (AND logic)</li>
<li>
<p><strong>Between terms</strong>: Any term can be true (OR logic)</p>
</li>
<li>
<p><strong>Required vs Preferred</strong>:</p>
</li>
<li><code>requiredDuringScheduling</code>: MUST be satisfied (hard rule)</li>
<li>
<p><code>preferredDuringScheduling</code>: SHOULD be satisfied (soft rule, weighted 1-100)</p>
</li>
<li>
<p><code>IgnoredDuringExecution</code>: Once scheduled, rules aren't re-evaluated if labels change</p>
</li>
</ol>
<hr />
<h2 id="2-pod-affinity-theory-relationships-between-pods"><strong>2. Pod Affinity Theory: Relationships Between Pods</strong></h2>
<h3 id="three-types-of-pod-relationships"><strong>Three Types of Pod Relationships:</strong></h3>
<ol>
<li><strong>Pod Affinity</strong>: "Run near these pods" (attraction)</li>
<li><strong>Pod Anti-Affinity</strong>: "Don't run near these pods" (repulsion)</li>
<li><strong>Topology</strong>: Defines what "near" means</li>
</ol>
<h3 id="topology-keys-theory"><strong>Topology Keys Theory:</strong></h3>
<p>A topology key is a <strong>node label</strong> that defines a grouping domain:</p>
<ul>
<li><strong><code>kubernetes.io/hostname</code></strong> = Different physical/virtual machines</li>
<li><strong><code>topology.kubernetes.io/zone</code></strong> = Different availability zones</li>
<li><strong><code>topology.kubernetes.io/region</code></strong> = Different geographic regions</li>
<li><strong>Custom keys</strong> = Your own grouping logic (e.g., <code>rack</code>, <code>row</code>, <code>datacenter</code>)</li>
</ul>
<h3 id="how-pod-affinity-works"><strong>How Pod Affinity Works:</strong></h3>
<p><div class="highlight"><pre><span></span><code><span class="nt">podAntiAffinity</span><span class="p">:</span>
<span class="w">  </span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">labelSelector</span><span class="p">:</span>
<span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span><span class="w">  </span><span class="c1"># Look for pods with this label</span>
<span class="w">    </span><span class="nt">topologyKey</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes.io/hostname</span><span class="w">  </span><span class="c1"># Group by node</span>
</code></pre></div>
<strong>Translation</strong>: "Don't schedule this pod on any node that already has a pod with label <code>app=web</code>"</p>
<hr />
<h2 id="3-complete-practical-example-with-theory-applied"><strong>3. Complete Practical Example with Theory Applied</strong></h2>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example-app</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example</span>
<span class="w">        </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">backend</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">affinity</span><span class="p">:</span>
<span class="w">        </span><span class="c1"># NODE AFFINITY: Where can pods go?</span>
<span class="w">        </span><span class="nt">nodeAffinity</span><span class="p">:</span>
<span class="w">          </span><span class="c1"># HARD REQUIREMENT: Must be satisfied</span>
<span class="w">          </span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span>
<span class="w">            </span><span class="nt">nodeSelectorTerms</span><span class="p">:</span>
<span class="w">            </span><span class="c1"># Term 1: Production environment</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">matchExpressions</span><span class="p">:</span>
<span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">environment</span>
<span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">In</span>
<span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;production&quot;</span><span class="p p-Indicator">]</span>
<span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">available</span>
<span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Exists</span>
<span class="w">            </span><span class="c1"># Term 2: OR staging with SSD</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">matchExpressions</span><span class="p">:</span>
<span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">environment</span>
<span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">In</span>
<span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;staging&quot;</span><span class="p p-Indicator">]</span>
<span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">storage-type</span>
<span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">In</span>
<span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;ssd&quot;</span><span class="p p-Indicator">]</span>

<span class="w">          </span><span class="c1"># SOFT PREFERENCE: Try to satisfy</span>
<span class="w">          </span><span class="nt">preferredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">90</span><span class="w">  </span><span class="c1"># Higher weight = more important</span>
<span class="w">            </span><span class="nt">preference</span><span class="p">:</span>
<span class="w">              </span><span class="nt">matchExpressions</span><span class="p">:</span>
<span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">zone</span>
<span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">In</span>
<span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;us-east-1a&quot;</span><span class="p p-Indicator">]</span>

<span class="w">        </span><span class="c1"># POD ANTI-AFFINITY: How pods relate to each other</span>
<span class="w">        </span><span class="nt">podAntiAffinity</span><span class="p">:</span>
<span class="w">          </span><span class="c1"># HARD: Don&#39;t put pods on same node</span>
<span class="w">          </span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">labelSelector</span><span class="p">:</span>
<span class="w">              </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">                </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example</span><span class="w">  </span><span class="c1"># Look for our own pods</span>
<span class="w">            </span><span class="nt">topologyKey</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes.io/hostname</span><span class="w">  </span><span class="c1"># Different nodes</span>

<span class="w">          </span><span class="c1"># SOFT: Try to spread across zones</span>
<span class="w">          </span><span class="nt">preferredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">70</span>
<span class="w">            </span><span class="nt">podAffinityTerm</span><span class="p">:</span>
<span class="w">              </span><span class="nt">labelSelector</span><span class="p">:</span>
<span class="w">                </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">                  </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example</span>
<span class="w">              </span><span class="nt">topologyKey</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">topology.kubernetes.io/zone</span><span class="w">  </span><span class="c1"># Different zones</span>

<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</code></pre></div>
<p><strong>Theory Applied:</strong>
1. <strong>Node Selection</strong>: Pods can run in production (any storage) OR staging (only SSD)
2. <strong>Preference</strong>: Prefer zone us-east-1a if possible
3. <strong>Pod Placement</strong>: Never on same node, try for different zones
4. <strong>Result</strong>: High availability across failure domains</p>
<hr />
<h2 id="4-when-to-use-each-feature-decision-guide"><strong>4. When to Use Each Feature - Decision Guide</strong></h2>
<h3 id="use-node-affinity-when"><strong>Use Node Affinity When:</strong></h3>
<ul>
<li>Pod needs specific hardware (GPU, SSD, memory)</li>
<li>Pod needs to run in specific region/zone</li>
<li>You want to dedicate nodes to certain workloads</li>
<li>You need to exclude certain node types</li>
</ul>
<h3 id="use-pod-affinity-when"><strong>Use Pod Affinity When:</strong></h3>
<ul>
<li>Related pods should be co-located (app + cache)</li>
<li>You need data locality (pod near its data)</li>
<li>Communication latency matters</li>
</ul>
<h3 id="use-pod-anti-affinity-when"><strong>Use Pod Anti-Affinity When:</strong></h3>
<ul>
<li>You need high availability (spread across nodes/zones)</li>
<li>You want to avoid resource contention</li>
<li>You have stateful applications that shouldn't share nodes</li>
</ul>
<h3 id="use-topology-spread-constraints-alternative"><strong>Use Topology Spread Constraints (Alternative):</strong></h3>
<ul>
<li>For simpler "spread evenly" requirements</li>
<li>When you want built-in balancing</li>
<li>For zone/region spreading without complex rules</li>
</ul>
<hr />
<h2 id="5-practice-questions"><strong>5. Practice Questions</strong></h2>
<h3 id="question-1-basic-node-affinity"><strong>Question 1: Basic Node Affinity</strong></h3>
<p>Create a Deployment that:
1. Name: <code>cache-app</code>
2. Replicas: 2
3. Image: <code>redis:alpine</code>
4. Must run on nodes with label <code>memory-type=high</code>
5. Should prefer nodes with label <code>storage=ssd</code> (weight: 80)
6. Pods should not be on the same node</p>
<h3 id="question-2-complex-node-selection"><strong>Question 2: Complex Node Selection</strong></h3>
<p>Create a StatefulSet that:
1. Name: <code>postgres-cluster</code>
2. Replicas: 3
3. Image: <code>postgres:15</code>
4. Requirements:
   - Must be in production environment
   - Must have fast storage (any label with "fast" in key)
   - Must NOT be on spot instances
   - Must NOT be under maintenance
5. Each pod should have 10Gi persistent storage</p>
<h3 id="question-3-pod-anti-affinity-for-ha"><strong>Question 3: Pod Anti-Affinity for HA</strong></h3>
<p>Create a Deployment that:
1. Name: <code>web-frontend</code>
2. Replicas: 5
3. Image: <code>nginx:latest</code>
4. Requirements:
   - Hard rule: Pods must be on different nodes
   - Soft rule: Try to spread across zones (weight: 100)
   - Pods should prefer to run near cache pods (weight: 60)
5. Add readiness and liveness probes</p>
<h3 id="question-4-complete-production-setup"><strong>Question 4: Complete Production Setup</strong></h3>
<p>Create a complete application with:
1. Deployment: <code>api-server</code> (3 replicas)
2. Deployment: <code>redis-cache</code> (2 replicas)
3. Requirements:
   - Both must run in <code>environment=production</code>
   - API pods should be on same nodes as cache pods
   - API pods should be spread across zones
   - Cache pods should be on different nodes
   - Prefer nodes with label <code>instance-type=large</code>
4. Include all necessary: resources, probes, environment variables</p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../../11-coredns/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../../11-coredns/" class="btn btn-xs btn-link">
        Index
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../nodeselector/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../nodeselector/" class="btn btn-xs btn-link">
        NodeSelector
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
  <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>