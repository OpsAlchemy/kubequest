<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="Vikash Kumar">
    <link rel="canonical" href="https://opsalchemy.github.io/kubequest/compose/05-kubeconfig/solutions/">
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Kubeconfig &amp; PKI - Complete Solutions Guide - CKA Exam Mastery</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <link href="../../stylesheets/extra.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Kubeconfig \u0026amp; PKI - Complete Solutions Guide", url: "#_top", children: [
              {title: "Challenge 1: Certificate Analysis in Running Cluster", url: "#challenge-1-certificate-analysis-in-running-cluster" },
              {title: "Challenge 2: Multi-Cluster Kubeconfig Management", url: "#challenge-2-multi-cluster-kubeconfig-management" },
              {title: "Challenge 3: Create Users Using Kubernetes CSR API", url: "#challenge-3-create-users-using-kubernetes-csr-api" },
              {title: "Challenge 4: Build a User Provisioning Automation Script", url: "#challenge-4-build-a-user-provisioning-automation-script" },
              {title: "Challenge 5: Troubleshoot Certificate Mismatches", url: "#challenge-5-troubleshoot-certificate-mismatches" },
              {title: "Challenge 6: Monitor Certificate Expiration", url: "#challenge-6-monitor-certificate-expiration" },
              {title: "Challenge 7: Certificate Renewal Workflow", url: "#challenge-7-certificate-renewal-workflow" },
              {title: "Challenge 8: Custom Certificate with Specific SANs", url: "#challenge-8-custom-certificate-with-specific-sans" },
              {title: "Challenge 9: Embedded vs Referenced Certificates", url: "#challenge-9-embedded-vs-referenced-certificates" },
              {title: "Challenge 10: Complete User Lifecycle", url: "#challenge-10-complete-user-lifecycle" },
              {title: "Challenge 11: CSR Management in Kubernetes", url: "#challenge-11-csr-management-in-kubernetes" },
              {title: "Challenge 12: Multi-Cluster User Management", url: "#challenge-12-multi-cluster-user-management" },
              {title: "Challenge 13: Kubeconfig Recovery and Backup", url: "#challenge-13-kubeconfig-recovery-and-backup" },
              {title: "Challenge 14: Understanding Certificate Authorities", url: "#challenge-14-understanding-certificate-authorities" },
              {title: "Challenge 15: Real-World Incident Response", url: "#challenge-15-real-world-incident-response" },
              {title: "Challenge 16: Kubelet Client Certificate Rotation", url: "#challenge-16-kubelet-client-certificate-rotation" },
              {title: "Challenge 17: Service Account Token and RBAC", url: "#challenge-17-service-account-token-and-rbac" },
              {title: "Challenge 18: System Component Authentication", url: "#challenge-18-system-component-authentication" },
              {title: "Challenge 19: Network Policy and mTLS", url: "#challenge-19-network-policy-and-mtls" },
              {title: "Challenge 20: Audit Logging", url: "#challenge-20-audit-logging" },
              {title: "Quick Reference", url: "#quick-reference" },
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script>
      <script src="../../javascripts/extra.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../06-cluster-certificates-and-kube-system%20%5Bimportant%5D/kubeadm-certs/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../06-cluster-certificates-and-kube-system%20%5Bimportant%5D/kubeadm-certs/" class="btn btn-xs btn-link">
        kubeadm Certificate Checks &amp; Renewal
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../question/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../question/" class="btn btn-xs btn-link">
        Kubeconfig &amp; Kubernetes PKI - Practical Challenges
      </a>
    </div>
    
  </div>

    

    <h1 id="kubeconfig-pki-complete-solutions-guide">Kubeconfig &amp; PKI - Complete Solutions Guide</h1>
<p>Solutions for all 20 challenges in <code>question.md</code>. Use kind clusters for all exercises.</p>
<hr />
<h2 id="challenge-1-certificate-analysis-in-running-cluster">Challenge 1: Certificate Analysis in Running Cluster</h2>
<h3 id="setup">Setup</h3>
<div class="highlight"><pre><span></span><code>kind<span class="w"> </span>create<span class="w"> </span>cluster<span class="w"> </span>--name<span class="w"> </span>cka-cluster
</code></pre></div>
<h3 id="step-1-find-all-certificate-files">Step 1: Find all certificate files</h3>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>cka-cluster-control-plane<span class="w"> </span>ls<span class="w"> </span>-la<span class="w"> </span>/etc/kubernetes/pki/

<span class="c1"># Output includes:</span>
<span class="c1"># ca.crt, ca.key                    - Cluster CA</span>
<span class="c1"># apiserver.crt, apiserver.key      - API Server cert</span>
<span class="c1"># apiserver-etcd-client.crt/key     - API server to etcd auth</span>
<span class="c1"># apiserver-kubelet-client.crt/key  - API server to kubelet auth</span>
<span class="c1"># front-proxy-ca.crt/key            - Aggregation layer CA</span>
<span class="c1"># front-proxy-client.crt/key        - Aggregation layer client</span>
<span class="c1"># sa.key, sa.pub                    - Service account signing keys</span>
<span class="c1"># etcd/                             - ETCD certificates directory</span>
</code></pre></div>
<h3 id="step-2-get-ca-common-name">Step 2: Get CA Common Name</h3>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>cka-cluster-control-plane<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>openssl<span class="w"> </span>x509<span class="w"> </span>-in<span class="w"> </span>/etc/kubernetes/pki/ca.crt<span class="w"> </span>-noout<span class="w"> </span>-subject

<span class="c1"># Output: subject=CN = kubernetes</span>
</code></pre></div>
<h3 id="step-3-verify-ca-is-self-signed">Step 3: Verify CA is self-signed</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Compare subject and issuer - if same, it&#39;s self-signed</span>
docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>cka-cluster-control-plane<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>openssl<span class="w"> </span>x509<span class="w"> </span>-in<span class="w"> </span>/etc/kubernetes/pki/ca.crt<span class="w"> </span>-noout<span class="w"> </span>-subject<span class="w"> </span>-issuer

<span class="c1"># Output:</span>
<span class="c1"># subject=CN = kubernetes</span>
<span class="c1"># issuer=CN = kubernetes</span>
<span class="c1"># Same subject and issuer = self-signed</span>
</code></pre></div>
<h3 id="step-4-check-api-server-certificate-issuer">Step 4: Check API server certificate issuer</h3>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>cka-cluster-control-plane<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>openssl<span class="w"> </span>x509<span class="w"> </span>-in<span class="w"> </span>/etc/kubernetes/pki/apiserver.crt<span class="w"> </span>-noout<span class="w"> </span>-issuer

<span class="c1"># Output: issuer=CN = kubernetes</span>
<span class="c1"># Issued by the cluster CA</span>
</code></pre></div>
<h3 id="step-5-extract-ca-from-kubeconfig">Step 5: Extract CA from kubeconfig</h3>
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>config<span class="w"> </span>view<span class="w"> </span>--raw<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">&#39;certificate-authority-data&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-1<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $2}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>base64<span class="w"> </span>-d<span class="w"> </span>&gt;<span class="w"> </span>extracted-ca.crt

openssl<span class="w"> </span>x509<span class="w"> </span>-in<span class="w"> </span>extracted-ca.crt<span class="w"> </span>-noout<span class="w"> </span>-dates
<span class="c1"># notBefore=...</span>
<span class="c1"># notAfter=...</span>
</code></pre></div>
<h3 id="step-6-calculate-days-until-expiration">Step 6: Calculate days until expiration</h3>
<div class="highlight"><pre><span></span><code><span class="nv">EXPIRY</span><span class="o">=</span><span class="k">$(</span>openssl<span class="w"> </span>x509<span class="w"> </span>-in<span class="w"> </span>extracted-ca.crt<span class="w"> </span>-noout<span class="w"> </span>-enddate<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="s1">&#39;=&#39;</span><span class="w"> </span>-f2<span class="k">)</span>
<span class="nv">EXPIRY_EPOCH</span><span class="o">=</span><span class="k">$(</span>date<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$EXPIRY</span><span class="s2">&quot;</span><span class="w"> </span>+%s<span class="k">)</span>
<span class="nv">CURRENT_EPOCH</span><span class="o">=</span><span class="k">$(</span>date<span class="w"> </span>+%s<span class="k">)</span>
<span class="nv">DAYS_LEFT</span><span class="o">=</span><span class="k">$((</span><span class="w"> </span><span class="o">(</span><span class="nv">$EXPIRY_EPOCH</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">$CURRENT_EPOCH</span><span class="o">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">86400</span><span class="w"> </span><span class="k">))</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Days until CA expiration: </span><span class="nv">$DAYS_LEFT</span><span class="s2">&quot;</span>
</code></pre></div>
<h3 id="step-7-list-api-server-sans-dns-names">Step 7: List API server SANs (DNS names)</h3>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>cka-cluster-control-plane<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>openssl<span class="w"> </span>x509<span class="w"> </span>-in<span class="w"> </span>/etc/kubernetes/pki/apiserver.crt<span class="w"> </span>-text<span class="w"> </span>-noout<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-A1<span class="w"> </span><span class="s2">&quot;Subject Alternative Name&quot;</span>

<span class="c1"># Or extract just DNS names:</span>
docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>cka-cluster-control-plane<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>openssl<span class="w"> </span>x509<span class="w"> </span>-in<span class="w"> </span>/etc/kubernetes/pki/apiserver.crt<span class="w"> </span>-text<span class="w"> </span>-noout<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;DNS:&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="w"> </span><span class="s1">&#39;\n&#39;</span>
</code></pre></div>
<h3 id="step-8-list-api-server-sans-ip-addresses">Step 8: List API server SANs (IP addresses)</h3>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>cka-cluster-control-plane<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>openssl<span class="w"> </span>x509<span class="w"> </span>-in<span class="w"> </span>/etc/kubernetes/pki/apiserver.crt<span class="w"> </span>-text<span class="w"> </span>-noout<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;IP Address&quot;</span>
</code></pre></div>
<h3 id="complete-analysis-script">Complete Analysis Script</h3>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1"># cert-analyzer.sh</span>

<span class="nv">CLUSTER_NAME</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">cka</span><span class="p">-cluster</span><span class="si">}</span>
<span class="nv">NODE</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CLUSTER_NAME</span><span class="si">}</span><span class="s2">-control-plane&quot;</span>
<span class="nv">PKI_PATH</span><span class="o">=</span><span class="s2">&quot;/etc/kubernetes/pki&quot;</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;=== Certificate Analysis for </span><span class="nv">$CLUSTER_NAME</span><span class="s2"> ===&quot;</span>

<span class="c1"># CA Certificate</span>
<span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n--- Cluster CA ---&quot;</span>
docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$NODE</span><span class="s2">&quot;</span><span class="w"> </span>openssl<span class="w"> </span>x509<span class="w"> </span>-in<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PKI_PATH</span><span class="s2">/ca.crt&quot;</span><span class="w"> </span>-noout<span class="w"> </span>-subject<span class="w"> </span>-issuer<span class="w"> </span>-dates

<span class="c1"># Check if self-signed</span>
<span class="nv">SUBJECT</span><span class="o">=</span><span class="k">$(</span>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$NODE</span><span class="s2">&quot;</span><span class="w"> </span>openssl<span class="w"> </span>x509<span class="w"> </span>-in<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PKI_PATH</span><span class="s2">/ca.crt&quot;</span><span class="w"> </span>-noout<span class="w"> </span>-subject<span class="k">)</span>
<span class="nv">ISSUER</span><span class="o">=</span><span class="k">$(</span>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$NODE</span><span class="s2">&quot;</span><span class="w"> </span>openssl<span class="w"> </span>x509<span class="w"> </span>-in<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PKI_PATH</span><span class="s2">/ca.crt&quot;</span><span class="w"> </span>-noout<span class="w"> </span>-issuer<span class="k">)</span>
<span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$SUBJECT</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ISSUER</span><span class="p">/issuer/subject</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Self-signed: YES&quot;</span>
<span class="k">else</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Self-signed: NO&quot;</span>
<span class="k">fi</span>

<span class="c1"># Days until expiration</span>
<span class="nv">EXPIRY</span><span class="o">=</span><span class="k">$(</span>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$NODE</span><span class="s2">&quot;</span><span class="w"> </span>openssl<span class="w"> </span>x509<span class="w"> </span>-in<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PKI_PATH</span><span class="s2">/ca.crt&quot;</span><span class="w"> </span>-noout<span class="w"> </span>-enddate<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="s1">&#39;=&#39;</span><span class="w"> </span>-f2<span class="k">)</span>
<span class="nv">EXPIRY_EPOCH</span><span class="o">=</span><span class="k">$(</span>date<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$EXPIRY</span><span class="s2">&quot;</span><span class="w"> </span>+%s<span class="k">)</span>
<span class="nv">CURRENT_EPOCH</span><span class="o">=</span><span class="k">$(</span>date<span class="w"> </span>+%s<span class="k">)</span>
<span class="nv">DAYS</span><span class="o">=</span><span class="k">$((</span><span class="w"> </span><span class="o">(</span><span class="nv">$EXPIRY_EPOCH</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">$CURRENT_EPOCH</span><span class="o">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">86400</span><span class="w"> </span><span class="k">))</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Days until expiration: </span><span class="nv">$DAYS</span><span class="s2">&quot;</span>

<span class="c1"># API Server Certificate</span>
<span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n--- API Server Certificate ---&quot;</span>
docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$NODE</span><span class="s2">&quot;</span><span class="w"> </span>openssl<span class="w"> </span>x509<span class="w"> </span>-in<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PKI_PATH</span><span class="s2">/apiserver.crt&quot;</span><span class="w"> </span>-noout<span class="w"> </span>-subject<span class="w"> </span>-issuer

<span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\nSANs (DNS names):&quot;</span>
docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$NODE</span><span class="s2">&quot;</span><span class="w"> </span>openssl<span class="w"> </span>x509<span class="w"> </span>-in<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PKI_PATH</span><span class="s2">/apiserver.crt&quot;</span><span class="w"> </span>-text<span class="w"> </span>-noout<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;DNS:&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="w"> </span><span class="s1">&#39;\n&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">&#39;s/^[[:space:]]*//&#39;</span>

<span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\nSANs (IP addresses):&quot;</span>
docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$NODE</span><span class="s2">&quot;</span><span class="w"> </span>openssl<span class="w"> </span>x509<span class="w"> </span>-in<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PKI_PATH</span><span class="s2">/apiserver.crt&quot;</span><span class="w"> </span>-text<span class="w"> </span>-noout<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;IP Address&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="w"> </span><span class="s1">&#39;\n&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">&#39;s/^[[:space:]]*//&#39;</span>
</code></pre></div>
<h3 id="why-multiple-sans-are-needed">Why multiple SANs are needed</h3>
<p>The API server certificate needs multiple DNS names and IPs because clients connect via different addresses:
- <code>kubernetes</code> - internal service name
- <code>kubernetes.default</code> - namespaced service name
- <code>kubernetes.default.svc</code> - full service name
- <code>kubernetes.default.svc.cluster.local</code> - FQDN
- <code>localhost</code> - local connections
- Node hostname - external access
- Cluster IP (10.96.0.1) - service IP
- Node IP - direct node access</p>
<h3 id="cleanup">Cleanup</h3>
<div class="highlight"><pre><span></span><code>kind<span class="w"> </span>delete<span class="w"> </span>cluster<span class="w"> </span>--name<span class="w"> </span>cka-cluster
</code></pre></div>
<hr />
<h2 id="challenge-2-multi-cluster-kubeconfig-management">Challenge 2: Multi-Cluster Kubeconfig Management</h2>
<h3 id="step-1-create-three-clusters">Step 1: Create three clusters</h3>
<div class="highlight"><pre><span></span><code>kind<span class="w"> </span>create<span class="w"> </span>cluster<span class="w"> </span>--name<span class="w"> </span>prod-cluster
kind<span class="w"> </span>create<span class="w"> </span>cluster<span class="w"> </span>--name<span class="w"> </span>staging-cluster
kind<span class="w"> </span>create<span class="w"> </span>cluster<span class="w"> </span>--name<span class="w"> </span>dev-cluster
</code></pre></div>
<h3 id="step-2-get-individual-kubeconfigs">Step 2: Get individual kubeconfigs</h3>
<div class="highlight"><pre><span></span><code>kind<span class="w"> </span>get<span class="w"> </span>kubeconfig<span class="w"> </span>--name<span class="w"> </span>prod-cluster<span class="w"> </span>&gt;<span class="w"> </span>prod.kubeconfig
kind<span class="w"> </span>get<span class="w"> </span>kubeconfig<span class="w"> </span>--name<span class="w"> </span>staging-cluster<span class="w"> </span>&gt;<span class="w"> </span>staging.kubeconfig
kind<span class="w"> </span>get<span class="w"> </span>kubeconfig<span class="w"> </span>--name<span class="w"> </span>dev-cluster<span class="w"> </span>&gt;<span class="w"> </span>dev.kubeconfig
</code></pre></div>
<h3 id="step-3-merge-kubeconfigs">Step 3: Merge kubeconfigs</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Set KUBECONFIG to all files</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">KUBECONFIG</span><span class="o">=</span>prod.kubeconfig:staging.kubeconfig:dev.kubeconfig

<span class="c1"># Merge and flatten into single file</span>
kubectl<span class="w"> </span>config<span class="w"> </span>view<span class="w"> </span>--flatten<span class="w"> </span>&gt;<span class="w"> </span>merged.kubeconfig

<span class="c1"># Use merged config</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">KUBECONFIG</span><span class="o">=</span>merged.kubeconfig
</code></pre></div>
<h3 id="step-4-create-namespaces-in-each-cluster">Step 4: Create namespaces in each cluster</h3>
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>config<span class="w"> </span>use-context<span class="w"> </span>kind-prod-cluster
kubectl<span class="w"> </span>create<span class="w"> </span>namespace<span class="w"> </span>production

kubectl<span class="w"> </span>config<span class="w"> </span>use-context<span class="w"> </span>kind-staging-cluster
kubectl<span class="w"> </span>create<span class="w"> </span>namespace<span class="w"> </span>staging

kubectl<span class="w"> </span>config<span class="w"> </span>use-context<span class="w"> </span>kind-dev-cluster
kubectl<span class="w"> </span>create<span class="w"> </span>namespace<span class="w"> </span>development
</code></pre></div>
<h3 id="step-5-set-default-namespaces-per-context">Step 5: Set default namespaces per context</h3>
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>config<span class="w"> </span>set-context<span class="w"> </span>kind-prod-cluster<span class="w"> </span>--namespace<span class="o">=</span>production
kubectl<span class="w"> </span>config<span class="w"> </span>set-context<span class="w"> </span>kind-staging-cluster<span class="w"> </span>--namespace<span class="o">=</span>staging
kubectl<span class="w"> </span>config<span class="w"> </span>set-context<span class="w"> </span>kind-dev-cluster<span class="w"> </span>--namespace<span class="o">=</span>development
</code></pre></div>
<h3 id="step-6-context-switching-function">Step 6: Context switching function</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Add to ~/.bashrc or ~/.zshrc</span>
kctx<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="c1"># Interactive selection</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">ctx</span><span class="o">=</span><span class="k">$(</span>kubectl<span class="w"> </span>config<span class="w"> </span>get-contexts<span class="w"> </span>-o<span class="w"> </span>name<span class="w"> </span><span class="p">|</span><span class="w"> </span>fzf<span class="w"> </span>--prompt<span class="o">=</span><span class="s2">&quot;Select context: &quot;</span><span class="k">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ctx</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span>kubectl<span class="w"> </span>config<span class="w"> </span>use-context<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ctx</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="k">fi</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span>kubectl<span class="w"> </span>config<span class="w"> </span>use-context<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="c1"># Show current context info</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;---&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Cluster:   </span><span class="k">$(</span>kubectl<span class="w"> </span>config<span class="w"> </span>view<span class="w"> </span>--minify<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.clusters[0].name}&#39;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;User:      </span><span class="k">$(</span>kubectl<span class="w"> </span>config<span class="w"> </span>view<span class="w"> </span>--minify<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.users[0].name}&#39;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Namespace: </span><span class="k">$(</span>kubectl<span class="w"> </span>config<span class="w"> </span>view<span class="w"> </span>--minify<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.contexts[0].context.namespace}&#39;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="o">}</span>

<span class="c1"># Simple version without fzf</span>
kctx-simple<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Available contexts:&quot;</span>
<span class="w">        </span>kubectl<span class="w"> </span>config<span class="w"> </span>get-contexts
<span class="w">        </span><span class="k">return</span>
<span class="w">    </span><span class="k">fi</span>
<span class="w">    </span>kubectl<span class="w"> </span>config<span class="w"> </span>use-context<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Switched to: </span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Namespace: </span><span class="k">$(</span>kubectl<span class="w"> </span>config<span class="w"> </span>view<span class="w"> </span>--minify<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.contexts[0].context.namespace}&#39;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="o">}</span>
</code></pre></div>
<h3 id="step-7-verify-switching">Step 7: Verify switching</h3>
<div class="highlight"><pre><span></span><code>kctx<span class="w"> </span>kind-prod-cluster
kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w">  </span><span class="c1"># runs in production namespace</span>

kctx<span class="w"> </span>kind-staging-cluster
kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w">  </span><span class="c1"># runs in staging namespace</span>

kctx<span class="w"> </span>kind-dev-cluster
kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w">  </span><span class="c1"># runs in development namespace</span>
</code></pre></div>
<h3 id="cleanup_1">Cleanup</h3>
<div class="highlight"><pre><span></span><code>kind<span class="w"> </span>delete<span class="w"> </span>clusters<span class="w"> </span>prod-cluster<span class="w"> </span>staging-cluster<span class="w"> </span>dev-cluster
</code></pre></div>
<hr />
<h2 id="challenge-3-create-users-using-kubernetes-csr-api">Challenge 3: Create Users Using Kubernetes CSR API</h2>
<h3 id="setup_1">Setup</h3>
<div class="highlight"><pre><span></span><code>kind<span class="w"> </span>create<span class="w"> </span>cluster<span class="w"> </span>--name<span class="w"> </span>user-cluster
mkdir<span class="w"> </span>-p<span class="w"> </span>users/<span class="o">{</span>alice,bob,admin-carol<span class="o">}</span>
</code></pre></div>
<h3 id="step-1-generate-private-keys">Step 1: Generate private keys</h3>
<div class="highlight"><pre><span></span><code>openssl<span class="w"> </span>genrsa<span class="w"> </span>-out<span class="w"> </span>users/alice/alice.key<span class="w"> </span><span class="m">2048</span>
openssl<span class="w"> </span>genrsa<span class="w"> </span>-out<span class="w"> </span>users/bob/bob.key<span class="w"> </span><span class="m">2048</span>
openssl<span class="w"> </span>genrsa<span class="w"> </span>-out<span class="w"> </span>users/admin-carol/admin-carol.key<span class="w"> </span><span class="m">2048</span>
</code></pre></div>
<h3 id="step-2-create-csrs-with-cn-and-o-fields">Step 2: Create CSRs with CN and O fields</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Alice - developer</span>
openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w"> </span>-key<span class="w"> </span>users/alice/alice.key<span class="w"> </span>-out<span class="w"> </span>users/alice/alice.csr<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-subj<span class="w"> </span><span class="s2">&quot;/CN=alice/O=developers&quot;</span>

<span class="c1"># Bob - developer</span>
openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w"> </span>-key<span class="w"> </span>users/bob/bob.key<span class="w"> </span>-out<span class="w"> </span>users/bob/bob.csr<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-subj<span class="w"> </span><span class="s2">&quot;/CN=bob/O=developers&quot;</span>

<span class="c1"># Carol - admin</span>
openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w"> </span>-key<span class="w"> </span>users/admin-carol/admin-carol.key<span class="w"> </span>-out<span class="w"> </span>users/admin-carol/admin-carol.csr<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-subj<span class="w"> </span><span class="s2">&quot;/CN=admin-carol/O=kubeadm:cluster-admins&quot;</span>
</code></pre></div>
<h3 id="step-3-submit-csrs-to-kubernetes">Step 3: Submit CSRs to Kubernetes</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Function to create CSR object</span>
create_k8s_csr<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">name</span><span class="o">=</span><span class="nv">$1</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">csr_file</span><span class="o">=</span><span class="nv">$2</span>

<span class="w">    </span>cat<span class="w"> </span><span class="s">&lt;&lt;EOF | kubectl apply -f -</span>
<span class="s">apiVersion: certificates.k8s.io/v1</span>
<span class="s">kind: CertificateSigningRequest</span>
<span class="s">metadata:</span>
<span class="s">  name: ${name}-csr</span>
<span class="s">spec:</span>
<span class="s">  request: $(cat &quot;$csr_file&quot; | base64 | tr -d &#39;\n&#39;)</span>
<span class="s">  signerName: kubernetes.io/kube-apiserver-client</span>
<span class="s">  usages:</span>
<span class="s">  - client auth</span>
<span class="s">EOF</span>
<span class="o">}</span>

create_k8s_csr<span class="w"> </span>alice<span class="w"> </span>users/alice/alice.csr
create_k8s_csr<span class="w"> </span>bob<span class="w"> </span>users/bob/bob.csr
create_k8s_csr<span class="w"> </span>admin-carol<span class="w"> </span>users/admin-carol/admin-carol.csr
</code></pre></div>
<h3 id="step-4-approve-csrs">Step 4: Approve CSRs</h3>
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>certificate<span class="w"> </span>approve<span class="w"> </span>alice-csr
kubectl<span class="w"> </span>certificate<span class="w"> </span>approve<span class="w"> </span>bob-csr
kubectl<span class="w"> </span>certificate<span class="w"> </span>approve<span class="w"> </span>admin-carol-csr

<span class="c1"># Verify approval</span>
kubectl<span class="w"> </span>get<span class="w"> </span>csr
</code></pre></div>
<h3 id="step-5-extract-signed-certificates">Step 5: Extract signed certificates</h3>
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>get<span class="w"> </span>csr<span class="w"> </span>alice-csr<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.status.certificate}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>base64<span class="w"> </span>-d<span class="w"> </span>&gt;<span class="w"> </span>users/alice/alice.crt
kubectl<span class="w"> </span>get<span class="w"> </span>csr<span class="w"> </span>bob-csr<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.status.certificate}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>base64<span class="w"> </span>-d<span class="w"> </span>&gt;<span class="w"> </span>users/bob/bob.crt
kubectl<span class="w"> </span>get<span class="w"> </span>csr<span class="w"> </span>admin-carol-csr<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.status.certificate}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>base64<span class="w"> </span>-d<span class="w"> </span>&gt;<span class="w"> </span>users/admin-carol/admin-carol.crt
</code></pre></div>
<h3 id="step-6-add-users-to-kubeconfig">Step 6: Add users to kubeconfig</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Get cluster info</span>
<span class="nv">CLUSTER_NAME</span><span class="o">=</span><span class="s2">&quot;kind-user-cluster&quot;</span>
<span class="nv">API_SERVER</span><span class="o">=</span><span class="k">$(</span>kubectl<span class="w"> </span>config<span class="w"> </span>view<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s2">&quot;{.clusters[?(@.name==&#39;</span><span class="nv">$CLUSTER_NAME</span><span class="s2">&#39;)].cluster.server}&quot;</span><span class="k">)</span>

<span class="c1"># Add credentials</span>
kubectl<span class="w"> </span>config<span class="w"> </span>set-credentials<span class="w"> </span>alice<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--client-certificate<span class="o">=</span>users/alice/alice.crt<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--client-key<span class="o">=</span>users/alice/alice.key

kubectl<span class="w"> </span>config<span class="w"> </span>set-credentials<span class="w"> </span>bob<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--client-certificate<span class="o">=</span>users/bob/bob.crt<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--client-key<span class="o">=</span>users/bob/bob.key

kubectl<span class="w"> </span>config<span class="w"> </span>set-credentials<span class="w"> </span>admin-carol<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--client-certificate<span class="o">=</span>users/admin-carol/admin-carol.crt<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--client-key<span class="o">=</span>users/admin-carol/admin-carol.key
</code></pre></div>
<h3 id="step-7-create-contexts">Step 7: Create contexts</h3>
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>config<span class="w"> </span>set-context<span class="w"> </span>alice-context<span class="w"> </span>--cluster<span class="o">=</span><span class="nv">$CLUSTER_NAME</span><span class="w"> </span>--user<span class="o">=</span>alice
kubectl<span class="w"> </span>config<span class="w"> </span>set-context<span class="w"> </span>bob-context<span class="w"> </span>--cluster<span class="o">=</span><span class="nv">$CLUSTER_NAME</span><span class="w"> </span>--user<span class="o">=</span>bob
kubectl<span class="w"> </span>config<span class="w"> </span>set-context<span class="w"> </span>admin-carol-context<span class="w"> </span>--cluster<span class="o">=</span><span class="nv">$CLUSTER_NAME</span><span class="w"> </span>--user<span class="o">=</span>admin-carol
</code></pre></div>
<h3 id="step-8-create-rbac-permissions">Step 8: Create RBAC permissions</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Role for developers (read-only pods)</span>
cat<span class="w"> </span><span class="s">&lt;&lt;EOF | kubectl apply -f -</span>
<span class="s">apiVersion: rbac.authorization.k8s.io/v1</span>
<span class="s">kind: ClusterRole</span>
<span class="s">metadata:</span>
<span class="s">  name: pod-reader</span>
<span class="s">rules:</span>
<span class="s">- apiGroups: [&quot;&quot;]</span>
<span class="s">  resources: [&quot;pods&quot;]</span>
<span class="s">  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]</span>
<span class="s">---</span>
<span class="s">apiVersion: rbac.authorization.k8s.io/v1</span>
<span class="s">kind: ClusterRoleBinding</span>
<span class="s">metadata:</span>
<span class="s">  name: developers-pod-reader</span>
<span class="s">subjects:</span>
<span class="s">- kind: Group</span>
<span class="s">  name: developers</span>
<span class="s">  apiGroup: rbac.authorization.k8s.io</span>
<span class="s">roleRef:</span>
<span class="s">  kind: ClusterRole</span>
<span class="s">  name: pod-reader</span>
<span class="s">  apiGroup: rbac.authorization.k8s.io</span>
<span class="s">---</span>
<span class="s">apiVersion: rbac.authorization.k8s.io/v1</span>
<span class="s">kind: ClusterRoleBinding</span>
<span class="s">metadata:</span>
<span class="s">  name: admin-carol-cluster-admin</span>
<span class="s">subjects:</span>
<span class="s">- kind: Group</span>
<span class="s">  name: kubeadm:cluster-admins</span>
<span class="s">  apiGroup: rbac.authorization.k8s.io</span>
<span class="s">roleRef:</span>
<span class="s">  kind: ClusterRole</span>
<span class="s">  name: cluster-admin</span>
<span class="s">  apiGroup: rbac.authorization.k8s.io</span>
<span class="s">EOF</span>
</code></pre></div>
<h3 id="step-9-test-permissions">Step 9: Test permissions</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Test alice (developer) - can list pods</span>
kubectl<span class="w"> </span>--context<span class="o">=</span>alice-context<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-A
<span class="c1"># Should work</span>

<span class="c1"># Test alice - cannot delete pods</span>
kubectl<span class="w"> </span>--context<span class="o">=</span>alice-context<span class="w"> </span>delete<span class="w"> </span>pod<span class="w"> </span>test-pod<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
<span class="c1"># Error: pods &quot;test-pod&quot; is forbidden</span>

<span class="c1"># Test alice - cannot access nodes</span>
kubectl<span class="w"> </span>--context<span class="o">=</span>alice-context<span class="w"> </span>get<span class="w"> </span>nodes<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
<span class="c1"># Error: nodes is forbidden</span>

<span class="c1"># Test admin-carol - full access</span>
kubectl<span class="w"> </span>--context<span class="o">=</span>admin-carol-context<span class="w"> </span>get<span class="w"> </span>nodes
<span class="c1"># Should work</span>

kubectl<span class="w"> </span>--context<span class="o">=</span>admin-carol-context<span class="w"> </span>delete<span class="w"> </span>pod<span class="w"> </span>test-pod
<span class="c1"># Should work (if pod exists)</span>
</code></pre></div>
<h3 id="cleanup_2">Cleanup</h3>
<div class="highlight"><pre><span></span><code>kind<span class="w"> </span>delete<span class="w"> </span>cluster<span class="w"> </span>--name<span class="w"> </span>user-cluster
rm<span class="w"> </span>-rf<span class="w"> </span>users/
</code></pre></div>
<hr />
<h2 id="challenge-4-build-a-user-provisioning-automation-script">Challenge 4: Build a User Provisioning Automation Script</h2>
<h3 id="complete-script">Complete Script</h3>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1"># provision-user.sh - Automated user provisioning with certificates and RBAC</span>

<span class="nb">set</span><span class="w"> </span>-e

<span class="c1"># Arguments</span>
<span class="nv">USERNAME</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="p">:?Usage: </span><span class="nv">$0</span><span class="p"> &lt;username&gt; &lt;group&gt; [cluster-context]</span><span class="si">}</span>
<span class="nv">GROUP</span><span class="o">=</span><span class="si">${</span><span class="nv">2</span><span class="p">:?Usage: </span><span class="nv">$0</span><span class="p"> &lt;username&gt; &lt;group&gt; [cluster-context]</span><span class="si">}</span>
<span class="nv">CLUSTER_CONTEXT</span><span class="o">=</span><span class="si">${</span><span class="nv">3</span><span class="k">:-$(</span>kubectl<span class="w"> </span>config<span class="w"> </span>current-context<span class="k">)</span><span class="si">}</span>

<span class="c1"># Directories</span>
<span class="nv">USER_DIR</span><span class="o">=</span><span class="s2">&quot;users/</span><span class="si">${</span><span class="nv">USERNAME</span><span class="si">}</span><span class="s2">&quot;</span>
mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USER_DIR</span><span class="s2">&quot;</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;=== User Provisioning Script ===&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Username: </span><span class="nv">$USERNAME</span><span class="s2">&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Group: </span><span class="nv">$GROUP</span><span class="s2">&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Cluster: </span><span class="nv">$CLUSTER_CONTEXT</span><span class="s2">&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>

<span class="c1"># Step 1: Generate private key</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[1/10] Generating private key...&quot;</span>
openssl<span class="w"> </span>genrsa<span class="w"> </span>-out<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USER_DIR</span><span class="s2">/</span><span class="si">${</span><span class="nv">USERNAME</span><span class="si">}</span><span class="s2">.key&quot;</span><span class="w"> </span><span class="m">2048</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null
chmod<span class="w"> </span><span class="m">600</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USER_DIR</span><span class="s2">/</span><span class="si">${</span><span class="nv">USERNAME</span><span class="si">}</span><span class="s2">.key&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;  Key: </span><span class="nv">$USER_DIR</span><span class="s2">/</span><span class="si">${</span><span class="nv">USERNAME</span><span class="si">}</span><span class="s2">.key&quot;</span>

<span class="c1"># Step 2: Create CSR</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[2/10] Creating certificate signing request...&quot;</span>
openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w"> </span>-key<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USER_DIR</span><span class="s2">/</span><span class="si">${</span><span class="nv">USERNAME</span><span class="si">}</span><span class="s2">.key&quot;</span><span class="w"> </span>-out<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USER_DIR</span><span class="s2">/</span><span class="si">${</span><span class="nv">USERNAME</span><span class="si">}</span><span class="s2">.csr&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-subj<span class="w"> </span><span class="s2">&quot;/CN=</span><span class="si">${</span><span class="nv">USERNAME</span><span class="si">}</span><span class="s2">/O=</span><span class="si">${</span><span class="nv">GROUP</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;  CSR created with CN=</span><span class="si">${</span><span class="nv">USERNAME</span><span class="si">}</span><span class="s2">, O=</span><span class="si">${</span><span class="nv">GROUP</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="c1"># Step 3: Submit CSR to Kubernetes</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[3/10] Submitting CSR to Kubernetes...&quot;</span>
<span class="nv">CSR_NAME</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">USERNAME</span><span class="si">}</span><span class="s2">-csr-</span><span class="k">$(</span>date<span class="w"> </span>+%s<span class="k">)</span><span class="s2">&quot;</span>
cat<span class="w"> </span><span class="s">&lt;&lt;EOF | kubectl apply -f -</span>
<span class="s">apiVersion: certificates.k8s.io/v1</span>
<span class="s">kind: CertificateSigningRequest</span>
<span class="s">metadata:</span>
<span class="s">  name: ${CSR_NAME}</span>
<span class="s">spec:</span>
<span class="s">  request: $(cat &quot;$USER_DIR/${USERNAME}.csr&quot; | base64 | tr -d &#39;\n&#39;)</span>
<span class="s">  signerName: kubernetes.io/kube-apiserver-client</span>
<span class="s">  usages:</span>
<span class="s">  - client auth</span>
<span class="s">EOF</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;  CSR submitted: </span><span class="nv">$CSR_NAME</span><span class="s2">&quot;</span>

<span class="c1"># Step 4: Approve CSR</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[4/10] Approving CSR...&quot;</span>
kubectl<span class="w"> </span>certificate<span class="w"> </span>approve<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CSR_NAME</span><span class="s2">&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;  CSR approved&quot;</span>

<span class="c1"># Step 5: Wait for certificate</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[5/10] Waiting for certificate...&quot;</span>
<span class="k">for</span><span class="w"> </span>i<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">{</span><span class="m">1</span>..30<span class="o">}</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nv">CERT</span><span class="o">=</span><span class="k">$(</span>kubectl<span class="w"> </span>get<span class="w"> </span>csr<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CSR_NAME</span><span class="s2">&quot;</span><span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.status.certificate}&#39;</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="k">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CERT</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="k">break</span>
<span class="w">    </span><span class="k">fi</span>
<span class="w">    </span>sleep<span class="w"> </span><span class="m">1</span>
<span class="k">done</span>

<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CERT</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;  Timeout waiting for certificate&quot;</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="k">fi</span>

<span class="c1"># Step 6: Extract certificate</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[6/10] Extracting signed certificate...&quot;</span>
kubectl<span class="w"> </span>get<span class="w"> </span>csr<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CSR_NAME</span><span class="s2">&quot;</span><span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.status.certificate}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>base64<span class="w"> </span>-d<span class="w"> </span>&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USER_DIR</span><span class="s2">/</span><span class="si">${</span><span class="nv">USERNAME</span><span class="si">}</span><span class="s2">.crt&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;  Certificate: </span><span class="nv">$USER_DIR</span><span class="s2">/</span><span class="si">${</span><span class="nv">USERNAME</span><span class="si">}</span><span class="s2">.crt&quot;</span>

<span class="c1"># Step 7: Configure kubeconfig</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[7/10] Configuring kubeconfig...&quot;</span>
<span class="nv">CLUSTER_NAME</span><span class="o">=</span><span class="k">$(</span>kubectl<span class="w"> </span>config<span class="w"> </span>view<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s2">&quot;{.contexts[?(@.name==&#39;</span><span class="nv">$CLUSTER_CONTEXT</span><span class="s2">&#39;)].context.cluster}&quot;</span><span class="k">)</span>

kubectl<span class="w"> </span>config<span class="w"> </span>set-credentials<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USERNAME</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--client-certificate<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$USER_DIR</span><span class="s2">/</span><span class="si">${</span><span class="nv">USERNAME</span><span class="si">}</span><span class="s2">.crt&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--client-key<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$USER_DIR</span><span class="s2">/</span><span class="si">${</span><span class="nv">USERNAME</span><span class="si">}</span><span class="s2">.key&quot;</span>

kubectl<span class="w"> </span>config<span class="w"> </span>set-context<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">USERNAME</span><span class="si">}</span><span class="s2">-context&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--cluster<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$CLUSTER_NAME</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--user<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$USERNAME</span><span class="s2">&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;  Context created: </span><span class="si">${</span><span class="nv">USERNAME</span><span class="si">}</span><span class="s2">-context&quot;</span>

<span class="c1"># Step 8: Create RBAC</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[8/10] Creating RBAC permissions...&quot;</span>
<span class="k">case</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$GROUP</span><span class="s2">&quot;</span><span class="w"> </span><span class="k">in</span>
<span class="w">    </span><span class="s2">&quot;developers&quot;</span><span class="p">|</span><span class="s2">&quot;dev&quot;</span><span class="o">)</span>
<span class="w">        </span>cat<span class="w"> </span><span class="s">&lt;&lt;EOF | kubectl apply -f -</span>
<span class="s">apiVersion: rbac.authorization.k8s.io/v1</span>
<span class="s">kind: ClusterRoleBinding</span>
<span class="s">metadata:</span>
<span class="s">  name: ${USERNAME}-view</span>
<span class="s">subjects:</span>
<span class="s">- kind: User</span>
<span class="s">  name: ${USERNAME}</span>
<span class="s">  apiGroup: rbac.authorization.k8s.io</span>
<span class="s">roleRef:</span>
<span class="s">  kind: ClusterRole</span>
<span class="s">  name: view</span>
<span class="s">  apiGroup: rbac.authorization.k8s.io</span>
<span class="s">EOF</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;  Assigned &#39;view&#39; ClusterRole&quot;</span>
<span class="w">        </span><span class="p">;;</span>
<span class="w">    </span><span class="s2">&quot;admins&quot;</span><span class="p">|</span><span class="s2">&quot;kubeadm:cluster-admins&quot;</span><span class="o">)</span>
<span class="w">        </span>cat<span class="w"> </span><span class="s">&lt;&lt;EOF | kubectl apply -f -</span>
<span class="s">apiVersion: rbac.authorization.k8s.io/v1</span>
<span class="s">kind: ClusterRoleBinding</span>
<span class="s">metadata:</span>
<span class="s">  name: ${USERNAME}-cluster-admin</span>
<span class="s">subjects:</span>
<span class="s">- kind: User</span>
<span class="s">  name: ${USERNAME}</span>
<span class="s">  apiGroup: rbac.authorization.k8s.io</span>
<span class="s">roleRef:</span>
<span class="s">  kind: ClusterRole</span>
<span class="s">  name: cluster-admin</span>
<span class="s">  apiGroup: rbac.authorization.k8s.io</span>
<span class="s">EOF</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;  Assigned &#39;cluster-admin&#39; ClusterRole&quot;</span>
<span class="w">        </span><span class="p">;;</span>
<span class="w">    </span>*<span class="o">)</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;  Unknown group &#39;</span><span class="nv">$GROUP</span><span class="s2">&#39; - no RBAC created&quot;</span>
<span class="w">        </span><span class="p">;;</span>
<span class="k">esac</span>

<span class="c1"># Step 9: Test authentication</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[9/10] Testing authentication...&quot;</span>
<span class="k">if</span><span class="w"> </span>kubectl<span class="w"> </span>--context<span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">USERNAME</span><span class="si">}</span><span class="s2">-context&quot;</span><span class="w"> </span>auth<span class="w"> </span>can-i<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span><span class="p">&amp;</span>&gt;/dev/null<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;  Authentication successful&quot;</span>
<span class="k">else</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;  Authentication failed&quot;</span>
<span class="k">fi</span>

<span class="c1"># Step 10: Summary</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[10/10] Complete!&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;=== Summary ===&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;User:        </span><span class="nv">$USERNAME</span><span class="s2">&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Group:       </span><span class="nv">$GROUP</span><span class="s2">&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Context:     </span><span class="si">${</span><span class="nv">USERNAME</span><span class="si">}</span><span class="s2">-context&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Private key: </span><span class="nv">$USER_DIR</span><span class="s2">/</span><span class="si">${</span><span class="nv">USERNAME</span><span class="si">}</span><span class="s2">.key&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Certificate: </span><span class="nv">$USER_DIR</span><span class="s2">/</span><span class="si">${</span><span class="nv">USERNAME</span><span class="si">}</span><span class="s2">.crt&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;WARNING: Keep the private key secure!&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Usage: kubectl --context=</span><span class="si">${</span><span class="nv">USERNAME</span><span class="si">}</span><span class="s2">-context &lt;command&gt;&quot;</span>
</code></pre></div>
<h3 id="test-the-script">Test the script</h3>
<div class="highlight"><pre><span></span><code>chmod<span class="w"> </span>+x<span class="w"> </span>provision-user.sh

./provision-user.sh<span class="w"> </span>alice<span class="w"> </span>developers
./provision-user.sh<span class="w"> </span>bob<span class="w"> </span>developers
./provision-user.sh<span class="w"> </span>carol<span class="w"> </span>admins

<span class="c1"># Verify</span>
kubectl<span class="w"> </span>--context<span class="o">=</span>alice-context<span class="w"> </span>get<span class="w"> </span>pods
kubectl<span class="w"> </span>--context<span class="o">=</span>carol-context<span class="w"> </span>get<span class="w"> </span>nodes
</code></pre></div>
<hr />
<h2 id="challenge-5-troubleshoot-certificate-mismatches">Challenge 5: Troubleshoot Certificate Mismatches</h2>
<h3 id="scenario-1-certificate-signed-by-unknown-authority">Scenario 1: Certificate signed by unknown authority</h3>
<p><strong>Diagnosis:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># User gets error:</span>
<span class="c1"># x509: certificate signed by unknown authority</span>

<span class="c1"># Check if user cert is signed by cluster CA</span>
kubectl<span class="w"> </span>config<span class="w"> </span>view<span class="w"> </span>--raw<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.clusters[0].cluster.certificate-authority-data}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>base64<span class="w"> </span>-d<span class="w"> </span>&gt;<span class="w"> </span>cluster-ca.crt

<span class="c1"># Verify user cert against cluster CA</span>
openssl<span class="w"> </span>verify<span class="w"> </span>-CAfile<span class="w"> </span>cluster-ca.crt<span class="w"> </span>user.crt
<span class="c1"># If fails: user cert was NOT signed by this CA</span>
</code></pre></div>
<p><strong>Fix:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Option 1: Re-sign user cert with cluster CA</span>
<span class="c1"># Option 2: Update kubeconfig with correct CA</span>
kubectl<span class="w"> </span>config<span class="w"> </span>set-cluster<span class="w"> </span>&lt;cluster-name&gt;<span class="w"> </span>--certificate-authority<span class="o">=</span>correct-ca.crt
</code></pre></div>
<h3 id="scenario-2-hostname-mismatch">Scenario 2: Hostname mismatch</h3>
<p><strong>Diagnosis:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Error: x509: certificate is valid for X, not Y</span>

<span class="c1"># Check what SANs are in the cert</span>
openssl<span class="w"> </span>x509<span class="w"> </span>-in<span class="w"> </span>apiserver.crt<span class="w"> </span>-text<span class="w"> </span>-noout<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-A1<span class="w"> </span><span class="s2">&quot;Subject Alternative Name&quot;</span>

<span class="c1"># Compare with the hostname being used</span>
kubectl<span class="w"> </span>config<span class="w"> </span>view<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.clusters[0].cluster.server}&#39;</span>
</code></pre></div>
<p><strong>Fix:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Use a hostname that&#39;s in the certificate SAN</span>
<span class="c1"># Or regenerate cert with correct SANs</span>
</code></pre></div>
<h3 id="scenario-3-missing-context">Scenario 3: Missing context</h3>
<p><strong>Fix:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Create the missing context</span>
kubectl<span class="w"> </span>config<span class="w"> </span>set-context<span class="w"> </span>&lt;context-name&gt;<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--cluster<span class="o">=</span>&lt;cluster-name&gt;<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--user<span class="o">=</span>&lt;user-name&gt;<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--namespace<span class="o">=</span>&lt;namespace&gt;
</code></pre></div>
<hr />
<h2 id="challenge-6-monitor-certificate-expiration">Challenge 6: Monitor Certificate Expiration</h2>
<h3 id="expiration-monitoring-script">Expiration Monitoring Script</h3>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1"># cert-monitor.sh - Monitor certificate expiration</span>

<span class="nv">RED</span><span class="o">=</span><span class="s1">&#39;\033[0;31m&#39;</span>
<span class="nv">YELLOW</span><span class="o">=</span><span class="s1">&#39;\033[1;33m&#39;</span>
<span class="nv">GREEN</span><span class="o">=</span><span class="s1">&#39;\033[0;32m&#39;</span>
<span class="nv">NC</span><span class="o">=</span><span class="s1">&#39;\033[0m&#39;</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;=== Certificate Expiration Report ===&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Generated: </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>

<span class="nv">USERS</span><span class="o">=</span><span class="k">$(</span>kubectl<span class="w"> </span>config<span class="w"> </span>view<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.users[*].name}&#39;</span><span class="k">)</span>

<span class="nb">printf</span><span class="w"> </span><span class="s2">&quot;%-20s %-25s %-10s %s\n&quot;</span><span class="w"> </span><span class="s2">&quot;USER&quot;</span><span class="w"> </span><span class="s2">&quot;EXPIRES&quot;</span><span class="w"> </span><span class="s2">&quot;DAYS LEFT&quot;</span><span class="w"> </span><span class="s2">&quot;STATUS&quot;</span>
<span class="nb">printf</span><span class="w"> </span><span class="s2">&quot;%-20s %-25s %-10s %s\n&quot;</span><span class="w"> </span><span class="s2">&quot;----&quot;</span><span class="w"> </span><span class="s2">&quot;-------&quot;</span><span class="w"> </span><span class="s2">&quot;---------&quot;</span><span class="w"> </span><span class="s2">&quot;------&quot;</span>

<span class="k">for</span><span class="w"> </span>user<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nv">$USERS</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nv">CERT_DATA</span><span class="o">=</span><span class="k">$(</span>kubectl<span class="w"> </span>config<span class="w"> </span>view<span class="w"> </span>--raw<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s2">&quot;{.users[?(@.name==&#39;</span><span class="nv">$user</span><span class="s2">&#39;)].user.client-certificate-data}&quot;</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="k">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CERT_DATA</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nv">CERT_FILE</span><span class="o">=</span><span class="k">$(</span>kubectl<span class="w"> </span>config<span class="w"> </span>view<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s2">&quot;{.users[?(@.name==&#39;</span><span class="nv">$user</span><span class="s2">&#39;)].user.client-certificate}&quot;</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="k">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CERT_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CERT_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="nv">CERT_DATA</span><span class="o">=</span><span class="k">$(</span>cat<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CERT_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>base64<span class="k">)</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="nb">printf</span><span class="w"> </span><span class="s2">&quot;%-20s %-25s %-10s %s\n&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$user</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;N/A&quot;</span><span class="w"> </span><span class="s2">&quot;N/A&quot;</span><span class="w"> </span><span class="s2">&quot;NO CERT&quot;</span>
<span class="w">            </span><span class="k">continue</span>
<span class="w">        </span><span class="k">fi</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="nv">EXPIRY</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CERT_DATA</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>base64<span class="w"> </span>-d<span class="w"> </span><span class="p">|</span><span class="w"> </span>openssl<span class="w"> </span>x509<span class="w"> </span>-noout<span class="w"> </span>-enddate<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="s1">&#39;=&#39;</span><span class="w"> </span>-f2<span class="k">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$EXPIRY</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">printf</span><span class="w"> </span><span class="s2">&quot;%-20s %-25s %-10s %s\n&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$user</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;INVALID&quot;</span><span class="w"> </span><span class="s2">&quot;N/A&quot;</span><span class="w"> </span><span class="s2">&quot;ERROR&quot;</span>
<span class="w">        </span><span class="k">continue</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="nv">EXPIRY_EPOCH</span><span class="o">=</span><span class="k">$(</span>date<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$EXPIRY</span><span class="s2">&quot;</span><span class="w"> </span>+%s<span class="k">)</span>
<span class="w">    </span><span class="nv">CURRENT_EPOCH</span><span class="o">=</span><span class="k">$(</span>date<span class="w"> </span>+%s<span class="k">)</span>
<span class="w">    </span><span class="nv">DAYS_LEFT</span><span class="o">=</span><span class="k">$((</span><span class="w"> </span><span class="o">(</span><span class="nv">$EXPIRY_EPOCH</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">$CURRENT_EPOCH</span><span class="o">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">86400</span><span class="w"> </span><span class="k">))</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$DAYS_LEFT</span><span class="w"> </span>-lt<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nv">STATUS</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">RED</span><span class="si">}</span><span class="s2">EXPIRED</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">elif</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$DAYS_LEFT</span><span class="w"> </span>-lt<span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nv">STATUS</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">RED</span><span class="si">}</span><span class="s2">CRITICAL</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">elif</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$DAYS_LEFT</span><span class="w"> </span>-lt<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nv">STATUS</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">YELLOW</span><span class="si">}</span><span class="s2">WARNING</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="nv">STATUS</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">GREEN</span><span class="si">}</span><span class="s2">OK</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="nb">printf</span><span class="w"> </span><span class="s2">&quot;%-20s %-25s %-10s %b\n&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$user</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$EXPIRY</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$DAYS_LEFT</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$STATUS</span><span class="s2">&quot;</span>
<span class="k">done</span>
</code></pre></div>
<hr />
<h2 id="challenge-7-certificate-renewal-workflow">Challenge 7: Certificate Renewal Workflow</h2>
<h3 id="renewal-process">Renewal process</h3>
<div class="highlight"><pre><span></span><code><span class="nv">USERNAME</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span>
<span class="nv">USER_DIR</span><span class="o">=</span><span class="s2">&quot;users/</span><span class="nv">$USERNAME</span><span class="s2">&quot;</span>

<span class="c1"># Generate new private key</span>
openssl<span class="w"> </span>genrsa<span class="w"> </span>-out<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USER_DIR</span><span class="s2">/</span><span class="si">${</span><span class="nv">USERNAME</span><span class="si">}</span><span class="s2">-new.key&quot;</span><span class="w"> </span><span class="m">2048</span>

<span class="c1"># Create new CSR with same CN/O</span>
<span class="nv">OLD_SUBJECT</span><span class="o">=</span><span class="k">$(</span>openssl<span class="w"> </span>x509<span class="w"> </span>-in<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USER_DIR</span><span class="s2">/</span><span class="si">${</span><span class="nv">USERNAME</span><span class="si">}</span><span class="s2">.crt&quot;</span><span class="w"> </span>-noout<span class="w"> </span>-subject<span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">&#39;s/subject=//&#39;</span><span class="k">)</span>
openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w"> </span>-key<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USER_DIR</span><span class="s2">/</span><span class="si">${</span><span class="nv">USERNAME</span><span class="si">}</span><span class="s2">-new.key&quot;</span><span class="w"> </span>-out<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USER_DIR</span><span class="s2">/</span><span class="si">${</span><span class="nv">USERNAME</span><span class="si">}</span><span class="s2">-new.csr&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-subj<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$OLD_SUBJECT</span><span class="s2">&quot;</span>

<span class="c1"># Submit to Kubernetes</span>
<span class="nv">CSR_NAME</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">USERNAME</span><span class="si">}</span><span class="s2">-renewal-</span><span class="k">$(</span>date<span class="w"> </span>+%s<span class="k">)</span><span class="s2">&quot;</span>
cat<span class="w"> </span><span class="s">&lt;&lt;EOF | kubectl apply -f -</span>
<span class="s">apiVersion: certificates.k8s.io/v1</span>
<span class="s">kind: CertificateSigningRequest</span>
<span class="s">metadata:</span>
<span class="s">  name: ${CSR_NAME}</span>
<span class="s">spec:</span>
<span class="s">  request: $(cat &quot;$USER_DIR/${USERNAME}-new.csr&quot; | base64 | tr -d &#39;\n&#39;)</span>
<span class="s">  signerName: kubernetes.io/kube-apiserver-client</span>
<span class="s">  usages:</span>
<span class="s">  - client auth</span>
<span class="s">EOF</span>

<span class="c1"># Approve</span>
kubectl<span class="w"> </span>certificate<span class="w"> </span>approve<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CSR_NAME</span><span class="s2">&quot;</span>

<span class="c1"># Extract new certificate</span>
kubectl<span class="w"> </span>get<span class="w"> </span>csr<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CSR_NAME</span><span class="s2">&quot;</span><span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.status.certificate}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>base64<span class="w"> </span>-d<span class="w"> </span>&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USER_DIR</span><span class="s2">/</span><span class="si">${</span><span class="nv">USERNAME</span><span class="si">}</span><span class="s2">-new.crt&quot;</span>

<span class="c1"># Update kubeconfig</span>
kubectl<span class="w"> </span>config<span class="w"> </span>set-credentials<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USERNAME</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--client-certificate<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$USER_DIR</span><span class="s2">/</span><span class="si">${</span><span class="nv">USERNAME</span><span class="si">}</span><span class="s2">-new.crt&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--client-key<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$USER_DIR</span><span class="s2">/</span><span class="si">${</span><span class="nv">USERNAME</span><span class="si">}</span><span class="s2">-new.key&quot;</span>

<span class="c1"># Verify</span>
kubectl<span class="w"> </span>--context<span class="o">=</span><span class="si">${</span><span class="nv">USERNAME</span><span class="si">}</span>-context<span class="w"> </span>auth<span class="w"> </span>can-i<span class="w"> </span>get<span class="w"> </span>pods
</code></pre></div>
<h3 id="compare-certificates">Compare certificates</h3>
<div class="highlight"><pre><span></span><code><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;=== Old Certificate ===&quot;</span>
openssl<span class="w"> </span>x509<span class="w"> </span>-in<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USER_DIR</span><span class="s2">/</span><span class="si">${</span><span class="nv">USERNAME</span><span class="si">}</span><span class="s2">.crt&quot;</span><span class="w"> </span>-noout<span class="w"> </span>-subject<span class="w"> </span>-dates<span class="w"> </span>-serial

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;=== New Certificate ===&quot;</span>
openssl<span class="w"> </span>x509<span class="w"> </span>-in<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USER_DIR</span><span class="s2">/</span><span class="si">${</span><span class="nv">USERNAME</span><span class="si">}</span><span class="s2">-new.crt&quot;</span><span class="w"> </span>-noout<span class="w"> </span>-subject<span class="w"> </span>-dates<span class="w"> </span>-serial

<span class="c1"># Same: Subject (CN, O)</span>
<span class="c1"># Different: Serial, Dates</span>
</code></pre></div>
<hr />
<h2 id="challenge-8-custom-certificate-with-specific-sans">Challenge 8: Custom Certificate with Specific SANs</h2>
<h3 id="openssl-config-file">OpenSSL Config File</h3>
<div class="highlight"><pre><span></span><code>cat<span class="w"> </span>&gt;<span class="w"> </span>custom-cert.cnf<span class="w"> </span><span class="s">&lt;&lt;EOF</span>
<span class="s">[req]</span>
<span class="s">distinguished_name = req_distinguished_name</span>
<span class="s">req_extensions = v3_req</span>
<span class="s">prompt = no</span>

<span class="s">[req_distinguished_name]</span>
<span class="s">CN = custom-server</span>

<span class="s">[v3_req]</span>
<span class="s">basicConstraints = CA:FALSE</span>
<span class="s">keyUsage = nonRepudiation, digitalSignature, keyEncipherment</span>
<span class="s">extendedKeyUsage = serverAuth, clientAuth</span>
<span class="s">subjectAltName = @alt_names</span>

<span class="s">[alt_names]</span>
<span class="s">DNS.1 = custom-server</span>
<span class="s">DNS.2 = custom-server.default</span>
<span class="s">DNS.3 = custom-server.default.svc</span>
<span class="s">DNS.4 = custom-server.default.svc.cluster.local</span>
<span class="s">DNS.5 = localhost</span>
<span class="s">IP.1 = 10.96.0.100</span>
<span class="s">IP.2 = 127.0.0.1</span>
<span class="s">IP.3 = 192.168.1.100</span>
<span class="s">EOF</span>
</code></pre></div>
<h3 id="generate-certificate">Generate Certificate</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Generate key</span>
openssl<span class="w"> </span>genrsa<span class="w"> </span>-out<span class="w"> </span>custom-server.key<span class="w"> </span><span class="m">2048</span>

<span class="c1"># Create CSR with config</span>
openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w"> </span>-key<span class="w"> </span>custom-server.key<span class="w"> </span>-out<span class="w"> </span>custom-server.csr<span class="w"> </span>-config<span class="w"> </span>custom-cert.cnf

<span class="c1"># Sign with cluster CA</span>
docker<span class="w"> </span>cp<span class="w"> </span>&lt;cluster&gt;-control-plane:/etc/kubernetes/pki/ca.crt<span class="w"> </span>.
docker<span class="w"> </span>cp<span class="w"> </span>&lt;cluster&gt;-control-plane:/etc/kubernetes/pki/ca.key<span class="w"> </span>.

openssl<span class="w"> </span>x509<span class="w"> </span>-req<span class="w"> </span>-in<span class="w"> </span>custom-server.csr<span class="w"> </span>-CA<span class="w"> </span>ca.crt<span class="w"> </span>-CAkey<span class="w"> </span>ca.key<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-CAcreateserial<span class="w"> </span>-out<span class="w"> </span>custom-server.crt<span class="w"> </span>-days<span class="w"> </span><span class="m">365</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-extensions<span class="w"> </span>v3_req<span class="w"> </span>-extfile<span class="w"> </span>custom-cert.cnf
</code></pre></div>
<h3 id="verify-sans">Verify SANs</h3>
<div class="highlight"><pre><span></span><code>openssl<span class="w"> </span>x509<span class="w"> </span>-in<span class="w"> </span>custom-server.crt<span class="w"> </span>-text<span class="w"> </span>-noout<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-A15<span class="w"> </span><span class="s2">&quot;X509v3 extensions&quot;</span>
</code></pre></div>
<hr />
<h2 id="challenge-9-embedded-vs-referenced-certificates">Challenge 9: Embedded vs Referenced Certificates</h2>
<h3 id="embedded-certificates">Embedded certificates</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Embedded format in kubeconfig:</span>
<span class="c1"># client-certificate-data: LS0tLS1CRUdJTi...</span>
<span class="c1"># client-key-data: LS0tLS1CRUdJTi...</span>

kubectl<span class="w"> </span>config<span class="w"> </span>view<span class="w"> </span>--raw<span class="w">  </span><span class="c1"># Shows base64 encoded data inline</span>
</code></pre></div>
<h3 id="referenced-certificates">Referenced certificates</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Convert to file references</span>
kubectl<span class="w"> </span>config<span class="w"> </span>set-credentials<span class="w"> </span>alice<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--client-certificate<span class="o">=</span>/path/to/alice.crt<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--client-key<span class="o">=</span>/path/to/alice.key

<span class="c1"># Now kubeconfig shows:</span>
<span class="c1"># client-certificate: /path/to/alice.crt</span>
<span class="c1"># client-key: /path/to/alice.key</span>
</code></pre></div>
<h3 id="when-to-use-each">When to use each</h3>
<ul>
<li><strong>Embedded</strong>: Distribution, portability, single-file sharing</li>
<li><strong>Referenced</strong>: Local development, easier cert rotation, security</li>
</ul>
<hr />
<h2 id="challenge-10-complete-user-lifecycle">Challenge 10: Complete User Lifecycle</h2>
<p>Use provisioning script from Challenge 4, monitoring from Challenge 6, renewal from Challenge 7.</p>
<h3 id="user-removal">User removal</h3>
<div class="highlight"><pre><span></span><code><span class="nv">USERNAME</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span>

<span class="c1"># Remove from kubeconfig</span>
kubectl<span class="w"> </span>config<span class="w"> </span>delete-user<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USERNAME</span><span class="s2">&quot;</span>
kubectl<span class="w"> </span>config<span class="w"> </span>delete-context<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">USERNAME</span><span class="si">}</span><span class="s2">-context&quot;</span>

<span class="c1"># Remove RBAC</span>
kubectl<span class="w"> </span>delete<span class="w"> </span>clusterrolebinding<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">USERNAME</span><span class="si">}</span><span class="s2">-view&quot;</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null
kubectl<span class="w"> </span>delete<span class="w"> </span>clusterrolebinding<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">USERNAME</span><span class="si">}</span><span class="s2">-cluster-admin&quot;</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null

<span class="c1"># Delete local files</span>
rm<span class="w"> </span>-rf<span class="w"> </span><span class="s2">&quot;users/</span><span class="nv">$USERNAME</span><span class="s2">&quot;</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;User </span><span class="nv">$USERNAME</span><span class="s2"> removed&quot;</span>
</code></pre></div>
<hr />
<h2 id="challenge-11-csr-management-in-kubernetes">Challenge 11: CSR Management in Kubernetes</h2>
<h3 id="csr-operations">CSR operations</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># List CSRs</span>
kubectl<span class="w"> </span>get<span class="w"> </span>csr

<span class="c1"># View details</span>
kubectl<span class="w"> </span>describe<span class="w"> </span>csr<span class="w"> </span>&lt;csr-name&gt;

<span class="c1"># Decode original request</span>
kubectl<span class="w"> </span>get<span class="w"> </span>csr<span class="w"> </span>&lt;csr-name&gt;<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.spec.request}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>base64<span class="w"> </span>-d<span class="w"> </span><span class="p">|</span><span class="w"> </span>openssl<span class="w"> </span>req<span class="w"> </span>-text<span class="w"> </span>-noout

<span class="c1"># Approve/Deny</span>
kubectl<span class="w"> </span>certificate<span class="w"> </span>approve<span class="w"> </span>&lt;csr-name&gt;
kubectl<span class="w"> </span>certificate<span class="w"> </span>deny<span class="w"> </span>&lt;csr-name&gt;

<span class="c1"># Delete</span>
kubectl<span class="w"> </span>delete<span class="w"> </span>csr<span class="w"> </span>&lt;csr-name&gt;
</code></pre></div>
<h3 id="auto-approval-script">Auto-approval script</h3>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1"># auto-approve-csr.sh</span>

<span class="nv">ALLOWED_GROUPS</span><span class="o">=</span><span class="s2">&quot;developers,admins&quot;</span>

<span class="k">while</span><span class="w"> </span>true<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span>csr<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>kubectl<span class="w"> </span>get<span class="w"> </span>csr<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.items[?(@.status.conditions==null)].metadata.name}&#39;</span><span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="nv">REQUEST</span><span class="o">=</span><span class="k">$(</span>kubectl<span class="w"> </span>get<span class="w"> </span>csr<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$csr</span><span class="s2">&quot;</span><span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.spec.request}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>base64<span class="w"> </span>-d<span class="k">)</span>
<span class="w">        </span><span class="nv">ORG</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$REQUEST</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>openssl<span class="w"> </span>req<span class="w"> </span>-noout<span class="w"> </span>-subject<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-oP<span class="w"> </span><span class="s1">&#39;(?&lt;=O = )[^,]+&#39;</span><span class="k">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ALLOWED_GROUPS</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ORG</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Auto-approving CSR </span><span class="nv">$csr</span><span class="s2"> (group: </span><span class="nv">$ORG</span><span class="s2">)&quot;</span>
<span class="w">            </span>kubectl<span class="w"> </span>certificate<span class="w"> </span>approve<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$csr</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="k">fi</span>
<span class="w">    </span><span class="k">done</span>
<span class="w">    </span>sleep<span class="w"> </span><span class="m">10</span>
<span class="k">done</span>
</code></pre></div>
<hr />
<h2 id="challenge-12-multi-cluster-user-management">Challenge 12: Multi-Cluster User Management</h2>
<h3 id="create-same-user-in-multiple-clusters">Create same user in multiple clusters</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Create clusters</span>
kind<span class="w"> </span>create<span class="w"> </span>cluster<span class="w"> </span>--name<span class="w"> </span>prod
kind<span class="w"> </span>create<span class="w"> </span>cluster<span class="w"> </span>--name<span class="w"> </span>dev

<span class="c1"># Provision user in each</span>
kubectl<span class="w"> </span>config<span class="w"> </span>use-context<span class="w"> </span>kind-prod
./provision-user.sh<span class="w"> </span>shared-user<span class="w"> </span>developers

kubectl<span class="w"> </span>config<span class="w"> </span>use-context<span class="w"> </span>kind-dev
./provision-user.sh<span class="w"> </span>shared-user<span class="w"> </span>developers
</code></pre></div>
<h3 id="different-rbac-per-cluster">Different RBAC per cluster</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Prod: read-only</span>
kubectl<span class="w"> </span>--context<span class="o">=</span>kind-prod<span class="w"> </span>create<span class="w"> </span>clusterrolebinding<span class="w"> </span>shared-user-prod<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--clusterrole<span class="o">=</span>view<span class="w"> </span>--user<span class="o">=</span>shared-user

<span class="c1"># Dev: full access</span>
kubectl<span class="w"> </span>--context<span class="o">=</span>kind-dev<span class="w"> </span>create<span class="w"> </span>clusterrolebinding<span class="w"> </span>shared-user-dev<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--clusterrole<span class="o">=</span>cluster-admin<span class="w"> </span>--user<span class="o">=</span>shared-user
</code></pre></div>
<hr />
<h2 id="challenge-13-kubeconfig-recovery-and-backup">Challenge 13: Kubeconfig Recovery and Backup</h2>
<h3 id="backup-script">Backup script</h3>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="nv">BACKUP_DIR</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">/.kube/backups&quot;</span>
mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$BACKUP_DIR</span><span class="s2">&quot;</span>

<span class="nv">BACKUP_FILE</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BACKUP_DIR</span><span class="si">}</span><span class="s2">/kubeconfig-</span><span class="k">$(</span>date<span class="w"> </span>+%Y%m%d-%H%M%S<span class="k">)</span><span class="s2">.bak&quot;</span>
cp<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">/.kube/config&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$BACKUP_FILE</span><span class="s2">&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Backup: </span><span class="nv">$BACKUP_FILE</span><span class="s2">&quot;</span>

<span class="c1"># Keep only last 10 backups</span>
ls<span class="w"> </span>-t<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BACKUP_DIR</span><span class="si">}</span><span class="s2">&quot;</span>/*.bak<span class="w"> </span><span class="p">|</span><span class="w"> </span>tail<span class="w"> </span>-n<span class="w"> </span>+11<span class="w"> </span><span class="p">|</span><span class="w"> </span>xargs<span class="w"> </span>-r<span class="w"> </span>rm
</code></pre></div>
<h3 id="validation-script">Validation script</h3>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="k">for</span><span class="w"> </span>ctx<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>kubectl<span class="w"> </span>config<span class="w"> </span>get-contexts<span class="w"> </span>-o<span class="w"> </span>name<span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;Testing </span><span class="nv">$ctx</span><span class="s2">... &quot;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span>kubectl<span class="w"> </span>--context<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$ctx</span><span class="s2">&quot;</span><span class="w"> </span>cluster-info<span class="w"> </span><span class="p">&amp;</span>&gt;/dev/null<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;OK&quot;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;FAILED&quot;</span>
<span class="w">    </span><span class="k">fi</span>
<span class="k">done</span>
</code></pre></div>
<hr />
<h2 id="challenge-14-understanding-certificate-authorities">Challenge 14: Understanding Certificate Authorities</h2>
<h3 id="extract-all-cas">Extract all CAs</h3>
<div class="highlight"><pre><span></span><code><span class="nv">NODE</span><span class="o">=</span><span class="s2">&quot;&lt;cluster&gt;-control-plane&quot;</span>

docker<span class="w"> </span>cp<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$NODE</span><span class="s2">&quot;</span>:/etc/kubernetes/pki/ca.crt<span class="w"> </span>./cluster-ca.crt
docker<span class="w"> </span>cp<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$NODE</span><span class="s2">&quot;</span>:/etc/kubernetes/pki/front-proxy-ca.crt<span class="w"> </span>./front-proxy-ca.crt
docker<span class="w"> </span>cp<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$NODE</span><span class="s2">&quot;</span>:/etc/kubernetes/pki/etcd/ca.crt<span class="w"> </span>./etcd-ca.crt
</code></pre></div>
<h3 id="validate-cert-chains">Validate cert chains</h3>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="nv">NODE</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span><span class="s2">-control-plane&quot;</span>
<span class="nv">PKI</span><span class="o">=</span><span class="s2">&quot;/etc/kubernetes/pki&quot;</span>

verify_cert<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">cert</span><span class="o">=</span><span class="nv">$1</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">ca</span><span class="o">=</span><span class="nv">$2</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">name</span><span class="o">=</span><span class="nv">$3</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$NODE</span><span class="s2">&quot;</span><span class="w"> </span>openssl<span class="w"> </span>verify<span class="w"> </span>-CAfile<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ca</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$cert</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">&amp;</span>&gt;/dev/null<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;OK: </span><span class="nv">$name</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;FAIL: </span><span class="nv">$name</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">fi</span>
<span class="o">}</span>

verify_cert<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PKI</span><span class="s2">/apiserver.crt&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PKI</span><span class="s2">/ca.crt&quot;</span><span class="w"> </span><span class="s2">&quot;API Server&quot;</span>
verify_cert<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PKI</span><span class="s2">/front-proxy-client.crt&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PKI</span><span class="s2">/front-proxy-ca.crt&quot;</span><span class="w"> </span><span class="s2">&quot;Front Proxy&quot;</span>
verify_cert<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PKI</span><span class="s2">/etcd/server.crt&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PKI</span><span class="s2">/etcd/ca.crt&quot;</span><span class="w"> </span><span class="s2">&quot;ETCD Server&quot;</span>
</code></pre></div>
<hr />
<h2 id="challenge-15-real-world-incident-response">Challenge 15: Real-World Incident Response</h2>
<h3 id="incident-1-kubelet-certificate-expires">Incident 1: Kubelet certificate expires</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Diagnosis</span>
kubectl<span class="w"> </span>get<span class="w"> </span>nodes<span class="w">  </span><span class="c1"># Node shows NotReady</span>
docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>&lt;node&gt;<span class="w"> </span>openssl<span class="w"> </span>x509<span class="w"> </span>-in<span class="w"> </span>/var/lib/kubelet/pki/kubelet-client.crt<span class="w"> </span>-noout<span class="w"> </span>-dates

<span class="c1"># Fix: Restart kubelet (triggers rotation if enabled)</span>
docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>&lt;node&gt;<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>kubelet
</code></pre></div>
<h3 id="incident-2-user-certificate-theft">Incident 2: User certificate theft</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Revoke access</span>
kubectl<span class="w"> </span>delete<span class="w"> </span>clusterrolebinding<span class="w"> </span>&lt;user&gt;-binding
kubectl<span class="w"> </span>config<span class="w"> </span>delete-user<span class="w"> </span>&lt;user&gt;
kubectl<span class="w"> </span>config<span class="w"> </span>delete-context<span class="w"> </span>&lt;user&gt;-context

<span class="c1"># Provision new certificate</span>
./provision-user.sh<span class="w"> </span>&lt;user&gt;<span class="w"> </span>&lt;group&gt;
</code></pre></div>
<h3 id="incident-3-wrong-sans">Incident 3: Wrong SANs</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Diagnosis</span>
openssl<span class="w"> </span>x509<span class="w"> </span>-in<span class="w"> </span>server.crt<span class="w"> </span>-text<span class="w"> </span>-noout<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-A1<span class="w"> </span><span class="s2">&quot;Subject Alternative Name&quot;</span>

<span class="c1"># Fix: Regenerate with correct SANs using Challenge 8 process</span>
</code></pre></div>
<hr />
<h2 id="challenge-16-kubelet-client-certificate-rotation">Challenge 16: Kubelet Client Certificate Rotation</h2>
<h3 id="find-and-examine-kubelet-cert">Find and examine kubelet cert</h3>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>&lt;node&gt;<span class="w"> </span>ls<span class="w"> </span>-la<span class="w"> </span>/var/lib/kubelet/pki/
docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>&lt;node&gt;<span class="w"> </span>openssl<span class="w"> </span>x509<span class="w"> </span>-in<span class="w"> </span>/var/lib/kubelet/pki/kubelet-client-current.pem<span class="w"> </span>-noout<span class="w"> </span>-subject<span class="w"> </span>-dates
<span class="c1"># subject=O = system:nodes, CN = system:node:&lt;nodename&gt;</span>
</code></pre></div>
<h3 id="monitoring-script">Monitoring script</h3>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="k">for</span><span class="w"> </span>node<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>kubectl<span class="w"> </span>get<span class="w"> </span>nodes<span class="w"> </span>-o<span class="w"> </span>name<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="s1">&#39;/&#39;</span><span class="w"> </span>-f2<span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nv">CERT</span><span class="o">=</span><span class="s2">&quot;/var/lib/kubelet/pki/kubelet-client-current.pem&quot;</span>
<span class="w">    </span><span class="nv">EXPIRY</span><span class="o">=</span><span class="k">$(</span>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$node</span><span class="s2">&quot;</span><span class="w"> </span>openssl<span class="w"> </span>x509<span class="w"> </span>-in<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CERT</span><span class="s2">&quot;</span><span class="w"> </span>-noout<span class="w"> </span>-enddate<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="s1">&#39;=&#39;</span><span class="w"> </span>-f2<span class="k">)</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Node: </span><span class="nv">$node</span><span class="s2"> - Expires: </span><span class="nv">$EXPIRY</span><span class="s2">&quot;</span>
<span class="k">done</span>
</code></pre></div>
<hr />
<h2 id="challenge-17-service-account-token-and-rbac">Challenge 17: Service Account Token and RBAC</h2>
<h3 id="create-sa-with-kubeconfig">Create SA with kubeconfig</h3>
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>create<span class="w"> </span>namespace<span class="w"> </span>test-ns
kubectl<span class="w"> </span>create<span class="w"> </span>serviceaccount<span class="w"> </span>test-sa<span class="w"> </span>-n<span class="w"> </span>test-ns

<span class="nv">TOKEN</span><span class="o">=</span><span class="k">$(</span>kubectl<span class="w"> </span>create<span class="w"> </span>token<span class="w"> </span>test-sa<span class="w"> </span>-n<span class="w"> </span>test-ns<span class="k">)</span>
<span class="nv">API_SERVER</span><span class="o">=</span><span class="k">$(</span>kubectl<span class="w"> </span>config<span class="w"> </span>view<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.clusters[0].cluster.server}&#39;</span><span class="k">)</span>
<span class="nv">CA_DATA</span><span class="o">=</span><span class="k">$(</span>kubectl<span class="w"> </span>config<span class="w"> </span>view<span class="w"> </span>--raw<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.clusters[0].cluster.certificate-authority-data}&#39;</span><span class="k">)</span>

cat<span class="w"> </span>&gt;<span class="w"> </span>sa-kubeconfig.yaml<span class="w"> </span><span class="s">&lt;&lt;EOF</span>
<span class="s">apiVersion: v1</span>
<span class="s">kind: Config</span>
<span class="s">clusters:</span>
<span class="s">- cluster:</span>
<span class="s">    certificate-authority-data: $CA_DATA</span>
<span class="s">    server: $API_SERVER</span>
<span class="s">  name: cluster</span>
<span class="s">contexts:</span>
<span class="s">- context:</span>
<span class="s">    cluster: cluster</span>
<span class="s">    user: test-sa</span>
<span class="s">    namespace: test-ns</span>
<span class="s">  name: test-sa-context</span>
<span class="s">current-context: test-sa-context</span>
<span class="s">users:</span>
<span class="s">- name: test-sa</span>
<span class="s">  user:</span>
<span class="s">    token: $TOKEN</span>
<span class="s">EOF</span>

<span class="c1"># Add RBAC</span>
kubectl<span class="w"> </span>create<span class="w"> </span>role<span class="w"> </span>pod-reader<span class="w"> </span>--verb<span class="o">=</span>get,list<span class="w"> </span>--resource<span class="o">=</span>pods<span class="w"> </span>-n<span class="w"> </span>test-ns
kubectl<span class="w"> </span>create<span class="w"> </span>rolebinding<span class="w"> </span>test-sa-pods<span class="w"> </span>--role<span class="o">=</span>pod-reader<span class="w"> </span>--serviceaccount<span class="o">=</span>test-ns:test-sa<span class="w"> </span>-n<span class="w"> </span>test-ns
</code></pre></div>
<hr />
<h2 id="challenge-18-system-component-authentication">Challenge 18: System Component Authentication</h2>
<h3 id="extract-component-certificates">Extract component certificates</h3>
<div class="highlight"><pre><span></span><code><span class="nv">NODE</span><span class="o">=</span><span class="s2">&quot;&lt;cluster&gt;-control-plane&quot;</span>

<span class="c1"># Controller Manager</span>
docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$NODE</span><span class="s2">&quot;</span><span class="w"> </span>cat<span class="w"> </span>/etc/kubernetes/controller-manager.conf<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>grep<span class="w"> </span>client-certificate-data<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $2}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>base64<span class="w"> </span>-d<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>openssl<span class="w"> </span>x509<span class="w"> </span>-noout<span class="w"> </span>-subject
<span class="c1"># subject=CN = system:kube-controller-manager</span>

<span class="c1"># Scheduler</span>
docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$NODE</span><span class="s2">&quot;</span><span class="w"> </span>cat<span class="w"> </span>/etc/kubernetes/scheduler.conf<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>grep<span class="w"> </span>client-certificate-data<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $2}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>base64<span class="w"> </span>-d<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>openssl<span class="w"> </span>x509<span class="w"> </span>-noout<span class="w"> </span>-subject
<span class="c1"># subject=CN = system:kube-scheduler</span>
</code></pre></div>
<hr />
<h2 id="challenge-19-network-policy-and-mtls">Challenge 19: Network Policy and mTLS</h2>
<h3 id="install-calico-and-create-policies">Install Calico and create policies</h3>
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/calico.yaml

<span class="c1"># Default deny</span>
cat<span class="w"> </span><span class="s">&lt;&lt;EOF | kubectl apply -f -</span>
<span class="s">apiVersion: networking.k8s.io/v1</span>
<span class="s">kind: NetworkPolicy</span>
<span class="s">metadata:</span>
<span class="s">  name: default-deny</span>
<span class="s">  namespace: backend</span>
<span class="s">spec:</span>
<span class="s">  podSelector: {}</span>
<span class="s">  policyTypes:</span>
<span class="s">  - Ingress</span>
<span class="s">  - Egress</span>
<span class="s">EOF</span>

<span class="c1"># Allow frontend to backend</span>
cat<span class="w"> </span><span class="s">&lt;&lt;EOF | kubectl apply -f -</span>
<span class="s">apiVersion: networking.k8s.io/v1</span>
<span class="s">kind: NetworkPolicy</span>
<span class="s">metadata:</span>
<span class="s">  name: allow-frontend</span>
<span class="s">  namespace: backend</span>
<span class="s">spec:</span>
<span class="s">  podSelector: {}</span>
<span class="s">  ingress:</span>
<span class="s">  - from:</span>
<span class="s">    - namespaceSelector:</span>
<span class="s">        matchLabels:</span>
<span class="s">          name: frontend</span>
<span class="s">EOF</span>
</code></pre></div>
<hr />
<h2 id="challenge-20-audit-logging">Challenge 20: Audit Logging</h2>
<h3 id="kind-config-with-audit">Kind config with audit</h3>
<div class="highlight"><pre><span></span><code><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Cluster</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kind.x-k8s.io/v1alpha4</span>
<span class="nt">nodes</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">control-plane</span>
<span class="w">  </span><span class="nt">kubeadmConfigPatches</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">kind: ClusterConfiguration</span>
<span class="w">    </span><span class="no">apiServer:</span>
<span class="w">      </span><span class="no">extraArgs:</span>
<span class="w">        </span><span class="no">audit-log-path: /var/log/kubernetes/audit.log</span>
<span class="w">        </span><span class="no">audit-policy-file: /etc/kubernetes/audit-policy.yaml</span>
<span class="w">      </span><span class="no">extraVolumes:</span>
<span class="w">      </span><span class="no">- name: audit-policy</span>
<span class="w">        </span><span class="no">hostPath: /etc/kubernetes/audit-policy.yaml</span>
<span class="w">        </span><span class="no">mountPath: /etc/kubernetes/audit-policy.yaml</span>
<span class="w">      </span><span class="no">- name: audit-logs</span>
<span class="w">        </span><span class="no">hostPath: /var/log/kubernetes</span>
<span class="w">        </span><span class="no">mountPath: /var/log/kubernetes</span>
<span class="w">  </span><span class="nt">extraMounts</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hostPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./audit-policy.yaml</span>
<span class="w">    </span><span class="nt">containerPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/kubernetes/audit-policy.yaml</span>
</code></pre></div>
<h3 id="parse-audit-logs">Parse audit logs</h3>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>&lt;node&gt;<span class="w"> </span>cat<span class="w"> </span>/var/log/kubernetes/audit.log<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>jq<span class="w"> </span>-r<span class="w"> </span><span class="s1">&#39;select(.user.username != null) | &quot;\(.requestReceivedTimestamp) \(.user.username) \(.verb) \(.objectRef.resource)&quot;&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tail<span class="w"> </span>-20
</code></pre></div>
<hr />
<h2 id="quick-reference">Quick Reference</h2>
<div class="highlight"><pre><span></span><code><span class="c1"># View kubeconfig</span>
kubectl<span class="w"> </span>config<span class="w"> </span>view
kubectl<span class="w"> </span>config<span class="w"> </span>view<span class="w"> </span>--raw

<span class="c1"># Context management</span>
kubectl<span class="w"> </span>config<span class="w"> </span>get-contexts
kubectl<span class="w"> </span>config<span class="w"> </span>use-context<span class="w"> </span>&lt;name&gt;
kubectl<span class="w"> </span>config<span class="w"> </span>set-context<span class="w"> </span>&lt;name&gt;<span class="w"> </span>--cluster<span class="o">=</span>X<span class="w"> </span>--user<span class="o">=</span>Y<span class="w"> </span>--namespace<span class="o">=</span>Z

<span class="c1"># Certificate inspection</span>
openssl<span class="w"> </span>x509<span class="w"> </span>-in<span class="w"> </span>cert.crt<span class="w"> </span>-text<span class="w"> </span>-noout
openssl<span class="w"> </span>x509<span class="w"> </span>-in<span class="w"> </span>cert.crt<span class="w"> </span>-noout<span class="w"> </span>-subject<span class="w"> </span>-issuer<span class="w"> </span>-dates

<span class="c1"># CSR management</span>
kubectl<span class="w"> </span>get<span class="w"> </span>csr
kubectl<span class="w"> </span>certificate<span class="w"> </span>approve<span class="w"> </span>&lt;name&gt;
kubectl<span class="w"> </span>certificate<span class="w"> </span>deny<span class="w"> </span>&lt;name&gt;

<span class="c1"># Extract cert from kubeconfig</span>
kubectl<span class="w"> </span>config<span class="w"> </span>view<span class="w"> </span>--raw<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.users[0].user.client-certificate-data}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>base64<span class="w"> </span>-d
</code></pre></div>
<hr />
<p><strong>Last Updated:</strong> January 10, 2026</p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../06-cluster-certificates-and-kube-system%20%5Bimportant%5D/kubeadm-certs/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../06-cluster-certificates-and-kube-system%20%5Bimportant%5D/kubeadm-certs/" class="btn btn-xs btn-link">
        kubeadm Certificate Checks &amp; Renewal
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../question/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../question/" class="btn btn-xs btn-link">
        Kubeconfig &amp; Kubernetes PKI - Practical Challenges
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
  <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>