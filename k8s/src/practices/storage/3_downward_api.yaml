apiVersion: v1
kind: Pod
metadata:
  name: downward-api-demo
  namespace: default
  labels:
    app: demo-app
    tier: backend
    environment: test
  annotations:
    buildVersion: "1.2.3"
    commitHash: "abc123def456"
    description: "Pod demonstrating Downward API features"
spec:
  # Service account name is available only via env vars
  serviceAccountName: default
  containers:
  - name: main-container
    image: busybox
    command: ["sh", "-c", "echo 'Container started'; sleep 3600"]
    
    # ===== ENVIRONMENT VARIABLES =====
    env:
    # Pod-level fields via fieldRef
    - name: POD_NAME
      valueFrom:
        fieldRef:
          fieldPath: metadata.name
    - name: POD_NAMESPACE
      valueFrom:
        fieldRef:
          fieldPath: metadata.namespace
    - name: POD_UID
      valueFrom:
        fieldRef:
          fieldPath: metadata.uid
    - name: POD_LABEL_APP
      valueFrom:
        fieldRef:
          fieldPath: metadata.labels['app']
    - name: POD_ANNOTATION_BUILD_VERSION
      valueFrom:
        fieldRef:
          fieldPath: metadata.annotations['buildVersion']
    
    # Pod-level fields available ONLY via env vars (not volumes)
    - name: NODE_NAME
      valueFrom:
        fieldRef:
          fieldPath: spec.nodeName
    - name: SERVICE_ACCOUNT_NAME
      valueFrom:
        fieldRef:
          fieldPath: spec.serviceAccountName
    - name: POD_IP
      valueFrom:
        fieldRef:
          fieldPath: status.podIP
    - name: HOST_IP
      valueFrom:
        fieldRef:
          fieldPath: status.hostIP
    
    # Container-level resource fields via resourceFieldRef
    - name: CPU_LIMIT
      valueFrom:
        resourceFieldRef:
          containerName: main-container
          resource: limits.cpu
          divisor: 1m  # Returns limit in millicores
    - name: MEMORY_LIMIT
      valueFrom:
        resourceFieldRef:
          containerName: main-container
          resource: limits.memory
          divisor: 1Mi  # Returns limit in mebibytes
    - name: CPU_REQUEST
      valueFrom:
        resourceFieldRef:
          containerName: main-container
          resource: requests.cpu
    - name: MEMORY_REQUEST
      valueFrom:
        resourceFieldRef:
          containerName: main-container
          resource: requests.memory
    - name: EPHEMERAL_STORAGE_LIMIT
      valueFrom:
        resourceFieldRef:
          containerName: main-container
          resource: limits.ephemeral-storage

    resources:
      requests:
        memory: "64Mi"
        cpu: "250m"
        ephemeral-storage: "2Gi"
      limits:
        memory: "128Mi"
        cpu: "500m"
        ephemeral-storage: "4Gi"

    # ===== VOLUME MOUNTS =====
    volumeMounts:
    - name: podinfo
      mountPath: /etc/podinfo
      readOnly: true
    - name: podinfo-labels-annotations
      mountPath: /etc/podinfo-meta
      readOnly: true

  # Init container to show resource field ref works there too
  initContainers:
  - name: init-demo
    image: busybox
    command: ["sh", "-c", "echo 'CPU Limit: '; printenv CPU_LIMIT; exit 0"]
    env:
    - name: CPU_LIMIT
      valueFrom:
        resourceFieldRef:
          resource: limits.cpu
          divisor: 1m
    resources:
      limits:
        cpu: "500m"
        memory: "64Mi"

  # ===== VOLUMES =====
  volumes:
  - name: podinfo
    downwardAPI:
      items:
      # Pod-level fields available via volumes
      - path: "pod_name"
        fieldRef:
          fieldPath: metadata.name
      - path: "pod_namespace"
        fieldRef:
          fieldPath: metadata.namespace
      - path: "pod_uid"
        fieldRef:
          fieldPath: metadata.uid
      
      # Container-level resource fields via volumes
      - path: "cpu_limit"
        resourceFieldRef:
          containerName: main-container
          resource: limits.cpu
          divisor: 1m
      - path: "memory_limit"
        resourceFieldRef:
          containerName: main-container
          resource: limits.memory
          divisor: 1Mi
      - path: "cpu_request"
        resourceFieldRef:
          containerName: main-container
          resource: requests.cpu
      - path: "memory_request"
        resourceFieldRef:
          containerName: main-container
          resource: requests.memory

  # Separate volume for labels and annotations (only available via volumes)
  - name: podinfo-labels-annotations
    downwardAPI:
      items:
      - path: "labels"
        fieldRef:
          fieldPath: metadata.labels
      - path: "annotations"
        fieldRef:
          fieldPath: metadata.annotations

  # Restart policy and other specs
  restartPolicy: Always
  terminationGracePeriodSeconds: 30

---
apiVersion: v1
kind: Pod
metadata:
  name: kubernetes-downwardapi-volume-example
  labels:
    zone: us-est-coast
    cluster: test-cluster1
    rack: rack-22
  annotations:
    build: two
    builder: john-doe
spec:
  containers:
    - name: client-container
      image: registry.k8s.io/busybox:1.27.2
      command: ["sh", "-c"]
      args:
      - while true; do
          if [[ -e /etc/podinfo/labels ]]; then
            echo -en '\n\n'; cat /etc/podinfo/labels; fi;
          if [[ -e /etc/podinfo/annotations ]]; then
            echo -en '\n\n'; cat /etc/podinfo/annotations; fi;
          sleep 5;
        done;
      volumeMounts:
        - name: podinfo
          mountPath: /etc/podinfo
  volumes:
    - name: podinfo
      downwardAPI:
        items:
          - path: "labels"
            fieldRef:
              fieldPath: metadata.labels
          - path: "annotations"
            fieldRef:
              fieldPath: metadata.annotations
---
apiVersion: v1
kind: Pod 
metadata:
  name: downwardapi 
spec:
  containers:
    - name: api 
      image: busybox
      command:
        - sleep 
        - 3600 
  volumes:
    - name: details
      downwardAPI:
        items:
          - path: "labels"
            fieldRef:
              fieldPath: metadata.labels
      


